<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashflow Online | Edição Original</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2C3E50;
            --secondary: #3498DB;
            --success: #2ECC71;
            --danger: #E74C3C;
            --warning: #F39C12;
            --light: #ECF0F1;
            --dark: #2C3E50;
            --player1: #E74C3C;
            --player2: #3498DB;
            --player3: #2ECC71;
            --player4: #9B59B6;
            --player5: #F39C12;
            --player6: #1ABC9C;
            --protection: #27ae60;
        }

        body {
            background: linear-gradient(135deg, #1a2a3a, #2c3e50);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* CONFIGURAÇÃO INICIAL */
        .setup-screen {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--warning);
            max-width: 800px;
            margin: 20px auto;
        }

        .setup-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: bold;
            color: var(--warning);
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .player-names-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* TABELA DO TABULEIRO */
        .board-table-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            border: 2px solid var(--secondary);
        }

        .board-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
        }

        .board-table th {
            background: var(--secondary);
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
        }

        .board-table td {
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            vertical-align: middle;
            min-width: 120px;
            position: relative;
        }

        .board-table td:first-child {
            width: 40px;
            min-width: 40px;
        }

        .space-number {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--warning);
            padding: 2px 4px;
            background: rgba(243, 156, 18, 0.2);
            border-radius: 4px;
            display: inline-block;
            width: 30px;
        }

        .space-type {
            font-size: 0.8rem;
            margin: 3px 0;
        }

        .space-action {
            font-size: 0.75rem;
            color: #bdc3c7;
        }

        .player-markers-cell {
            min-width: 180px;
        }

        /* Cores dos espaços */
        .space-start { background: rgba(243, 156, 18, 0.15); border-left: 4px solid var(--warning); }
        .space-opportunity { background: rgba(52, 152, 219, 0.15); border-left: 4px solid var(--player2); }
        .space-payday { background: rgba(155, 89, 182, 0.15); border-left: 4px solid var(--player4); }
        .space-doodad { background: rgba(231, 76, 60, 0.25); border-left: 4px solid var(--player1); }
        .space-market { background: rgba(46, 204, 113, 0.15); border-left: 4px solid var(--success); }
        .space-baby { background: rgba(241, 196, 15, 0.15); border-left: 4px solid #F1C40F; }
        .space-downsized { background: rgba(230, 126, 34, 0.15); border-left: 4px solid #E67E22; }
        .space-charity { background: rgba(230, 126, 34, 0.15); border-left: 4px solid #E67E22; }

        /* Marcadores dos jogadores */
        .player-markers {
            display: flex;
            justify-content: center;
            gap: 3px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .player-marker {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* CONTROLES */
        .controls {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid var(--secondary);
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .dice {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            user-select: none;
        }

        .dice.rolling {
            animation: roll 0.5s infinite;
        }

        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .button-success { background: var(--success); }
        .button-danger { background: var(--danger); }
        .button-warning { background: var(--warning); }
        .button-purple { background: #9b59b6; }
        .button-protection { background: var(--protection); }

        /* CARD DISPLAY */
        .card-display {
            background: white;
            color: var(--dark);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: none;
            border-top: 8px solid var(--secondary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .card-title {
            color: var(--secondary);
            font-size: 1.3rem;
            font-weight: bold;
        }

        .card-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .card-detail {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }

        .detail-label {
            font-size: 0.85rem;
            color: #666;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 5px;
        }

        .card-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* MODAL PARA VENDA DE ATIVOS */
        .asset-selection-modal {
            max-height: 60vh;
            overflow-y: auto;
        }

        .asset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .asset-info {
            flex: 1;
        }

        .sell-checkbox {
            margin-left: 15px;
        }

        /* LOG */
        .log-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid var(--secondary);
        }

        .log-content {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .log-entry {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            color: var(--dark);
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .modal-title {
            color: var(--secondary);
            font-size: 1.4rem;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--danger);
        }

        /* INFORMAÇÕES DO JOGADOR ATUAL (AGORA ABAIXO DA TABELA) */
        .player-info-below-table {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid var(--warning);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .player-info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .info-label {
            font-size: 0.8rem;
            color: #bdc3c7;
            margin-bottom: 3px;
            text-align: center;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
        }

        .info-income { color: var(--success); }
        .info-expense { color: var(--danger); }
        .info-warning { color: var(--warning); }
        .info-protection { color: var(--protection); }

        /* DEBT INDICATOR */
        .debt-indicator {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--danger);
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: var(--danger);
            grid-column: 1 / -1;
            justify-content: center;
        }

        /* RESPONSIVO */
        @media (max-width: 768px) {
            .board-table {
                font-size: 0.8rem;
            }
            
            .board-table th,
            .board-table td {
                padding: 6px;
            }
            
            .board-table td:first-child {
                width: 30px;
                min-width: 30px;
            }
            
            .space-number {
                width: 25px;
                font-size: 0.8rem;
            }
            
            .player-markers-cell {
                min-width: 120px;
            }
            
            .dice-container {
                gap: 10px;
            }
            
            .dice {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .player-info-below-table {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .debt-indicator {
                grid-column: 1;
            }
        }

        /* CORES DOS JOGADORES */
        .color-1 { background: var(--player1); }
        .color-2 { background: var(--player2); }
        .color-3 { background: var(--player3); }
        .color-4 { background: var(--player4); }
        .color-5 { background: var(--player5); }
        .color-6 { background: var(--player6); }

        /* ANIMAÇÕES */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse-warning {
            animation: pulse 1s infinite;
        }

        /* GAME STATS */
        .game-stats {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            color: var(--warning);
            font-size: 1.1rem;
        }

        /* FAST TRACK (AGORA NO FINAL) */
        .fast-track-section {
            background: rgba(155, 89, 182, 0.3);
            border: 2px solid #9b59b6;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .fast-track-card {
            background: white;
            color: var(--dark);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 5px solid #9b59b6;
        }

        .fast-track-header {
            color: #9b59b6;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dream-achieved {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
        }

        /* PROFISSÕES INFO */
        .professions-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.85rem;
        }

        .professions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .profession-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 5px;
            border-left: 3px solid var(--warning);
        }

        /* BOTÃO DE EMPRÉSTIMO */
        .button-loan {
            background: #9b59b6;
        }

        /* PROTEÇÃO FINANCEIRA */
        .protection-badge {
            background: var(--protection);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- TELA DE CONFIGURAÇÃO -->
        <div id="setupScreen" class="setup-screen">
            <h2 style="color: var(--warning); text-align: center; margin-bottom: 20px;">
                <i class="fas fa-cogs"></i> CONFIGURAÇÃO DO JOGO
            </h2>
            
            <div class="setup-form">
                <div class="form-group">
                    <label><i class="fas fa-users"></i> NÚMERO DE JOGADORES (2-6)</label>
                    <select id="numPlayers">
                        <option value="2">2 Jogadores</option>
                        <option value="3">3 Jogadores</option>
                        <option value="4">4 Jogadores</option>
                        <option value="5">5 Jogadores</option>
                        <option value="6">6 Jogadores</option>
                    </select>
                </div>
                
                <div id="playerNamesContainer" class="player-names-container">
                    <!-- Nomes serão gerados aqui -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="button button-warning" id="startGameBtn" style="padding: 15px 40px; font-size: 1.1rem;">
                        <i class="fas fa-play"></i> INICIAR JOGO
                    </button>
                </div>
            </div>
        </div>

        <!-- ÁREA DO JOGO (inicialmente escondida) -->
        <div id="gameArea" style="display: none;">
            <header style="text-align: center; margin-bottom: 20px;">
                <h1 style="color: var(--warning); font-size: 2rem;">
                    <i class="fas fa-coins"></i> CASHFLOW ONLINE - EDIÇÃO ORIGINAL
                </h1>
                <p style="color: var(--light);">Fiel ao jogo de tabuleiro original</p>
            </header>

            <!-- INFORMAÇÕES DO JOGO -->
            <div class="game-stats">
                <div class="stat-item">
                    <div>Rodada Atual</div>
                    <div class="stat-value" id="currentRound">1</div>
                </div>
                <div class="stat-item">
                    <div>Status</div>
                    <div class="stat-value" id="gameStatus">CORRIDA DOS RATOS</div>
                </div>
                <div class="stat-item">
                    <div>Jogadores Fast Track</div>
                    <div class="stat-value" id="fastTrackCount">0</div>
                </div>
            </div>

            <!-- TABELA DO TABULEIRO -->
            <div class="board-table-container">
                <h3 style="color: var(--warning); margin-bottom: 15px; text-align: center;">
                    <i class="fas fa-table"></i> TABULEIRO - CORRIDA DOS RATOS
                </h3>
                <table class="board-table" id="boardTable">
                    <!-- Gerado dinamicamente -->
                </table>
            </div>

            <!-- INFORMAÇÕES DO JOGADOR ATUAL (AGORA ABAIXO DA TABELA) -->
            <div class="player-info-below-table" id="currentPlayerInfo">
                <!-- Informações serão inseridas aqui -->
            </div>

            <!-- CONTROLES -->
            <div class="controls">
                <h3 style="color: var(--warning); margin-bottom: 15px; text-align: center;">
                    <i class="fas fa-gamepad"></i> CONTROLES
                </h3>
                
                <div class="dice-container">
                    <div class="dice" id="dice1">?</div>
                    <div class="dice" id="dice2" style="display: none;">?</div>
                </div>
                
                <div>
                    <button class="button button-warning" id="rollDiceBtn">
                        <i class="fas fa-dice"></i> ROLAR DADOS
                    </button>
                    
                    <button class="button" id="endTurnBtn" disabled>
                        <i class="fas fa-forward"></i> FINALIZAR TURNO
                    </button>
                    
                    <button class="button button-success" id="showAssetsBtn">
                        <i class="fas fa-chart-pie"></i> MEUS ATIVOS
                    </button>
                    
                    <button class="button button-loan" id="takeLoanBtn">
                        <i class="fas fa-university"></i> PEGAR EMPRÉSTIMO
                    </button>
                    
                    <button class="button button-protection" id="useProtectionBtn" style="display: none;">
                        <i class="fas fa-shield-alt"></i> USAR PROTEÇÃO
                    </button>
                    
                    <button class="button button-purple" id="newGameBtn">
                        <i class="fas fa-redo"></i> NOVO JOGO
                    </button>
                </div>
                
                <div id="winnerMessage" style="margin-top: 15px;"></div>
            </div>

            <!-- ÁREA DE CARTAS -->
            <div class="card-display" id="cardDisplay">
                <div class="card-header">
                    <div class="card-title" id="cardTitle">OPORTUNIDADE</div>
                    <div id="cardTypeTag" style="background: #3498db; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;">
                        PEQUENA OPORTUNIDADE
                    </div>
                </div>
                
                <div id="cardDescription" style="margin-bottom: 15px;"></div>
                
                <div class="card-details" id="cardDetails">
                    <!-- Detalhes aqui -->
                </div>
                
                <div class="card-actions" id="cardActions">
                    <!-- Botões aqui -->
                </div>
            </div>

            <!-- LOG DO JOGO -->
            <div class="log-section">
                <h3 style="color: var(--warning); margin-bottom: 15px; text-align: center;">
                    <i class="fas fa-history"></i> HISTÓRICO DO JOGO
                </h3>
                <div class="log-content" id="gameLog">
                    <div class="log-entry">Jogo iniciado!</div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button class="button" onclick="clearLog()" style="padding: 8px 15px;">
                        <i class="fas fa-trash"></i> Limpar Histórico
                    </button>
                </div>
            </div>

            <!-- INFORMAÇÕES DAS PROFISSÕES -->
            <div class="professions-info" id="professionsInfo">
                <h4 style="color: var(--warning); margin-bottom: 10px;">
                    <i class="fas fa-user-tie"></i> PROFISSÕES DO JOGO
                </h4>
                <div class="professions-grid" id="professionsGrid">
                    <!-- Profissões serão inseridas aqui -->
                </div>
            </div>

            <!-- FAST TRACK SECTION (AGORA NO FINAL) -->
            <div class="fast-track-section" id="fastTrackSection">
                <h3 style="color: #9b59b6; margin-bottom: 15px; text-align: center;">
                    <i class="fas fa-bolt"></i> VIA RÁPIDA (FAST TRACK)
                </h3>
                <div id="fastTrackContent">
                    <!-- Conteúdo da via rápida -->
                </div>
            </div>
        </div>

        <!-- MODAL DE ATIVOS -->
        <div class="modal" id="assetsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="assetsTitle">MEUS ATIVOS</div>
                    <button class="close-modal" onclick="closeModal('assetsModal')">&times;</button>
                </div>
                <div id="assetsContent">
                    <!-- Conteúdo aqui -->
                </div>
            </div>
        </div>

        <!-- MODAL PARA VENDA DE IMÓVEIS -->
        <div class="modal" id="sellAssetsModal">
            <div class="modal-content asset-selection-modal">
                <div class="modal-header">
                    <div class="modal-title"><i class="fas fa-home"></i> VENDER IMÓVEIS</div>
                    <button class="close-modal" onclick="closeModal('sellAssetsModal')">&times;</button>
                </div>
                <div id="sellAssetsContent">
                    <!-- Lista de imóveis aqui -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="button button-success" onclick="confirmSellAssets()">
                        <i class="fas fa-check"></i> VENDER SELECIONADOS
                    </button>
                    <button class="button" onclick="closeModal('sellAssetsModal')">
                        <i class="fas fa-times"></i> CANCELAR
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL PARA VENDA DE AÇÕES -->
        <div class="modal" id="sellStocksModal">
            <div class="modal-content asset-selection-modal">
                <div class="modal-header">
                    <div class="modal-title"><i class="fas fa-chart-line"></i> VENDER AÇÕES</div>
                    <button class="close-modal" onclick="closeModal('sellStocksModal')">&times;</button>
                </div>
                <div id="sellStocksContent">
                    <!-- Lista de ações aqui -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="button button-success" onclick="confirmSellStocks()">
                        <i class="fas fa-check"></i> VENDER SELECIONADOS
                    </button>
                    <button class="button" onclick="closeModal('sellStocksModal')">
                        <i class="fas fa-times"></i> CANCELAR
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE EMPRÉSTIMO -->
        <div class="modal" id="loanModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title"><i class="fas fa-university"></i> PEGAR EMPRÉSTIMO</div>
                    <button class="close-modal" onclick="closeModal('loanModal')">&times;</button>
                </div>
                <div id="loanContent">
                    <!-- Conteúdo aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // =========== CONFIGURAÇÃO DO JOGO ===========
        const gameState = {
            currentPlayer: 1,
            gameActive: true,
            diceValue: 0,
            currentCard: null,
            totalPlayers: 2,
            players: {},
            spaces: [],
            dice3Enabled: false,
            charityPlayer: null,
            charityRoundsLeft: 0,
            currentRound: 1,
            totalLaps: 0,
            marketEvent: null,
            availableProfessions: [],
            playerDreams: {},
            nextDoodadProtected: false,
            protectedPlayer: null
        };

        // =========== PROFISSÕES DO JOGO ORIGINAL ===========
        const allProfessions = [
            {
                name: "Zelador (Janitor)",
                salary: 1600,
                initialCash: 400,
                perChildCost: 70,
                taxes: 280,
                mortgage: 300,
                carPayment: 100,
                creditCard: 60,
                otherExpenses: 190,
                studentLoan: 0
            },
            {
                name: "Caminhoneiro",
                salary: 2500,
                initialCash: 700,
                perChildCost: 140,
                taxes: 460,
                mortgage: 400,
                carPayment: 140,
                creditCard: 90,
                otherExpenses: 300,
                studentLoan: 0
            },
            {
                name: "Secretária",
                salary: 2500,
                initialCash: 500,
                perChildCost: 120,
                taxes: 460,
                mortgage: 400,
                carPayment: 120,
                creditCard: 90,
                otherExpenses: 300,
                studentLoan: 0
            },
            {
                name: "Policial",
                salary: 3000,
                initialCash: 500,
                perChildCost: 160,
                taxes: 580,
                mortgage: 500,
                carPayment: 160,
                creditCard: 120,
                otherExpenses: 350,
                studentLoan: 0
            },
            {
                name: "Professor",
                salary: 3300,
                initialCash: 500,
                perChildCost: 110,
                taxes: 630,
                mortgage: 500,
                carPayment: 150,
                creditCard: 120,
                otherExpenses: 360,
                studentLoan: 180
            },
            {
                name: "Mecânico",
                salary: 3300,
                initialCash: 700,
                perChildCost: 140,
                taxes: 630,
                mortgage: 500,
                carPayment: 200,
                creditCard: 120,
                otherExpenses: 360,
                studentLoan: 0
            },
            {
                name: "Enfermeiro",
                salary: 3600,
                initialCash: 600,
                perChildCost: 170,
                taxes: 700,
                mortgage: 600,
                carPayment: 200,
                creditCard: 140,
                otherExpenses: 380,
                studentLoan: 120
            },
            {
                name: "Gerente",
                salary: 4600,
                initialCash: 1000,
                perChildCost: 240,
                taxes: 910,
                mortgage: 900,
                carPayment: 300,
                creditCard: 220,
                otherExpenses: 500,
                studentLoan: 0
            },
            {
                name: "Engenheiro",
                salary: 4900,
                initialCash: 700,
                perChildCost: 250,
                taxes: 1050,
                mortgage: 750,
                carPayment: 300,
                creditCard: 220,
                otherExpenses: 550,
                studentLoan: 250
            },
            {
                name: "Advogado",
                salary: 7500,
                initialCash: 1000,
                perChildCost: 380,
                taxes: 1830,
                mortgage: 1100,
                carPayment: 300,
                creditCard: 220,
                otherExpenses: 630,
                studentLoan: 400
            },
            {
                name: "Piloto",
                salary: 9500,
                initialCash: 1000,
                perChildCost: 380,
                taxes: 2350,
                mortgage: 1300,
                carPayment: 400,
                creditCard: 300,
                otherExpenses: 750,
                studentLoan: 0
            },
            {
                name: "Médico",
                salary: 13000,
                initialCash: 1000,
                perChildCost: 640,
                taxes: 3400,
                mortgage: 1900,
                carPayment: 600,
                creditCard: 400,
                otherExpenses: 1000,
                studentLoan: 1000
            }
        ];

        // =========== SONHOS PARA CADA JOGADOR ===========
        const allDreams = [
            "Iate de Luxo",
            "Mansão na Praia",
            "Ferrari Vermelha",
            "Viagem ao Espaço",
            "Ilha Particular",
            "Coleção de Arte",
            "Helicóptero Particular",
            "Time de Futebol",
            "Castelo na Europa",
            "Cruzeiro ao Redor do Mundo",
            "Fazenda de Cavalos",
            "Observatório Astronômico"
        ];

        // =========== DOODADS ESCALONADOS POR VOLTAS ===========
        const doodadCardsByLaps = {
            "voltas_1_5": [
                {
                    name: "Celular Novo",
                    description: "Smartphone de última geração com plano de dados.",
                    cost: 800
                },
                {
                    name: "Reparo do Carro",
                    description: "Troca de pneus e manutenção básica.",
                    cost: 1200
                },
                {
                    name: "Consulta Médica",
                    description: "Consulta especializada com exames.",
                    cost: 500
                },
                {
                    name: "Computador Novo",
                    description: "Notebook para trabalho.",
                    cost: 3000
                },
                {
                    name: "Curso Online",
                    description: "Curso de especialização profissional.",
                    cost: 800
                },
                {
                    name: "Reparo Residencial",
                    description: "Vazamento e pequenos reparos em casa.",
                    cost: 1500
                },
                {
                    name: "TV 55''",
                    description: "Televisão smart básica.",
                    cost: 2500
                },
                {
                    name: "Jantar Especial",
                    description: "Jantar em restaurante fino para 2 pessoas.",
                    cost: 400
                }
            ],
            "voltas_6_10": [
                {
                    name: "Curso Presencial",
                    description: "Curso técnico ou profissionalizante.",
                    cost: 6000
                },
                {
                    name: "Troca de Eletrodomésticos",
                    description: "Geladeira e fogão novos.",
                    cost: 8000
                },
                {
                    name: "Manutenção do Carro",
                    description: "Reparo completo do motor.",
                    cost: 7500
                },
                {
                    name: "Tratamento Odontológico",
                    description: "Implante ou tratamento especializado.",
                    cost: 5000
                },
                {
                    name: "Viagem Nacional",
                    description: "Pacote de férias para 2 pessoas.",
                    cost: 10000
                },
                {
                    name: "Móveis Novos",
                    description: "Conjunto de sofá e poltronas.",
                    cost: 7000
                }
            ],
            "voltas_11_15": [
                {
                    name: "Reforma da Casa",
                    description: "Reforma completa da cozinha.",
                    cost: 15000
                },
                {
                    name: "Tratamento Médico",
                    description: "Cirurgia ou tratamento hospitalar.",
                    cost: 20000
                },
                {
                    name: "Imposto Atrasado",
                    description: "Multas e impostos em atraso.",
                    cost: 18000
                },
                {
                    name: "Problema Estrutural",
                    description: "Reparo de infiltração e fundação.",
                    cost: 22000
                },
                {
                    name: "Veículo Usado",
                    description: "Carro seminovo para necessidade.",
                    cost: 35000
                }
            ],
            "voltas_16_20": [
                {
                    name: "Carro Novo Popular",
                    description: "Veículo zero km entrada.",
                    cost: 35000
                },
                {
                    name: "Processo Judicial",
                    description: "Ação trabalhista ou cível.",
                    cost: 25000
                },
                {
                    name: "Emergência Familiar",
                    description: "Ajuda familiar urgente.",
                    cost: 30000
                },
                {
                    name: "Reforma Completa",
                    description: "Reforma de toda a casa.",
                    cost: 35000
                }
            ],
            "voltas_21_mais": [
                {
                    name: "Carro de Luxo",
                    description: "Veículo importado zero km.",
                    cost: 50000
                },
                {
                    name: "Crise Financeira",
                    description: "Grande emergência financeira.",
                    cost: 45000
                },
                {
                    name: "Emergência Familiar Grave",
                    description: "Problema de saúde familiar.",
                    cost: 60000
                },
                {
                    name: "Perda de Investimento",
                    description: "Falência de negócio parceiro.",
                    cost: 55000
                }
            ]
        };

        // =========== NOVAS CARTAS PEQUENAS OPORTUNIDADES (SMALL DEAL) - REBALANCEADAS ===========
        const smallDealCards = [
            {
                name: "LOANER - Ações a R$ 5 cada",
                type: "ações",
                description: "Corretora de investimentos. Compra mínima de 100 ações.",
                costPerShare: 5,
                shares: 100,
                downPayment: 500,
                cashflow: 0,
                roi: "Venda por R$ 40 por ação (somente em mercado)"
            },
            {
                name: "MYT4U - Ações a R$ 1 cada",
                type: "ações",
                description: "Empresa de tecnologia. Oportunidade de alto crescimento.",
                costPerShare: 1,
                shares: 100,
                downPayment: 100,
                cashflow: 0,
                roi: "Venda por R$ 8,00 por ação (50% por evento de mercado)"
            },
            {
                name: "ON2U - Ações a R$ 0,10 cada",
                type: "ações",
                description: "Startup de internet. Risco alto, potencial alto.",
                costPerShare: 0.10,
                shares: 1000,
                downPayment: 100,
                cashflow: 0,
                roi: "Venda por R$ 1,50 por ação (somente em mercado de alta)"
            },
            {
                name: "OK4U - Ações a R$ 10 cada",
                type: "ações",
                description: "Empresa de telecomunicações consolidada.",
                costPerShare: 10,
                shares: 100,
                downPayment: 1000,
                cashflow: 30
            },
            // NOVAS CARTAS COM JUROS CONVERTIDOS
            {
                name: "Previdência Privada",
                type: "títulos",
                description: "Plano de aposentadoria com retorno garantido.",
                cost: 5000,
                downPayment: 5000,
                annualReturn: 20,
                roi: "20% ao ano (convertido para 1.67% por Payday)"
            },
            {
                name: "Fundo Imobiliário",
                type: "fii",
                description: "Investimento em imóveis comerciais.",
                cost: 10000,
                downPayment: 10000,
                annualReturn: 12,
                roi: "12% ao ano (convertido para 1% por Payday)"
            },
            {
                name: "Investimento Conservador",
                type: "títulos",
                description: "Renda fixa de baixo risco.",
                cost: 8000,
                downPayment: 8000,
                annualReturn: 10,
                roi: "10% ao ano (convertido para 0.83% por Payday)"
            },
            {
                name: "Fundo de Renda Estável",
                type: "títulos",
                description: "Investimento com retorno consistente.",
                cost: 6000,
                downPayment: 6000,
                annualReturn: 8,
                roi: "8% ao ano (convertido para 0.67% por Payday)"
            },
            {
                name: "Seguro Contra Despesas",
                type: "proteção",
                description: "Anula o próximo Doodad que você cair. Uso único.",
                cost: 300,
                downPayment: 300,
                protection: true
            }
        ];

        // =========== BIG DEALS REBALANCEADAS ===========
        const bigDealCards = [
            {
                name: "Apartamento de 2 Quartos",
                type: "imóvel",
                description: "Apartamento para aluguel em área urbana.",
                cost: 65000,
                downPayment: 13000,
                mortgage: 52000,
                cashflow: 90,
                roi: "10% ao ano"
            },
            {
                name: "Casa de 3 Quartos com Piscina",
                type: "imóvel",
                description: "Casa familiar em bairro nobre.",
                cost: 135000,
                downPayment: 27000,
                mortgage: 108000,
                cashflow: 500,
                roi: "15% ao ano"
            },
            {
                name: "Prédio de 24 Apartamentos",
                type: "imóvel",
                description: "Edifício residencial com alta taxa de ocupação.",
                cost: 1200000,
                downPayment: 150000,
                mortgage: 1050000,
                cashflow: 3000,
                roi: "24% CCR",
                requires: "1 volta completa"
            },
            {
                name: "Shopping Center",
                type: "imóvel",
                description: "Complexo comercial com várias lojas.",
                cost: 5000000,
                downPayment: 600000,
                mortgage: 4400000,
                cashflow: 18000,
                roi: "36% CCR",
                requires: "Renda passiva mínima R$ 5.000/mês"
            },
            {
                name: "Franquia de Fast Food",
                type: "negócio",
                description: "Restaurante de rede conhecida.",
                cost: 250000,
                downPayment: 50000,
                mortgage: 200000,
                cashflow: 2000,
                roi: "48% CCR"
            },
            {
                name: "Empresa de Software",
                type: "negócio",
                description: "Startup de tecnologia com contrato governamental.",
                cost: 500000,
                downPayment: 100000,
                mortgage: 400000,
                cashflow: 3000,
                roi: "36% CCR",
                requires: "1 volta completa OU renda passiva R$ 2.000/mês"
            },
            // NOVAS BIG DEALS REBALANCEADAS
            {
                name: "Pequeno Negócio Local",
                type: "negócio",
                description: "Negócio familiar com clientela estabelecida.",
                cost: 8000,
                downPayment: 8000,
                cashflow: 300,
                requires: null
            },
            {
                name: "Franquia Emergente",
                type: "negócio",
                description: "Franquia de mercado em crescimento.",
                cost: 15000,
                downPayment: 15000,
                cashflow: 600,
                requires: null
            },
            {
                name: "Imóvel de Aluguel Simples",
                type: "imóvel",
                description: "Apartamento pequeno para aluguel.",
                cost: 20000,
                downPayment: 20000,
                cashflow: 800,
                requires: null
            },
            {
                name: "Negócio Digital",
                type: "negócio",
                description: "Site ou aplicativo com receita recorrente.",
                cost: 25000,
                downPayment: 25000,
                cashflow: 1000,
                requires: null
            },
            {
                name: "Imóvel Comercial",
                type: "imóvel",
                description: "Sala comercial em localização privilegiada.",
                cost: 40000,
                downPayment: 40000,
                cashflow: 1500,
                requires: null
            }
        ];

        // =========== CARTAS DE MERCADO ===========
        const marketCards = [
            {
                name: "IMÓVEIS VALORIZARAM!",
                type: "alta",
                assetType: "imóvel",
                description: "Grande demanda por imóveis! Você pode vender seus imóveis por um bom preço.",
                modifier: 1.5
            },
            {
                name: "AÇÕES EM ALTA!",
                type: "alta",
                assetType: "ações",
                description: "O mercado de ações está em alta! Você pode vender suas ações com lucro.",
                modifier: 2.0
            },
            {
                name: "CRISE IMOBILIÁRIA",
                type: "baixa",
                assetType: "imóvel",
                description: "O mercado imobiliário está em crise. Os preços caíram significativamente.",
                modifier: 0.7
            },
            {
                name: "BOLSA EM QUEDA LIVRE",
                type: "baixa",
                assetType: "ações",
                description: "Crise financeira global afetou o mercado de ações.",
                modifier: 0.5
            },
            {
                name: "JUROS SUBIRAM",
                type: "baixa",
                assetType: "títulos",
                description: "Taxa de juros aumentou, afetando títulos de renda fixa.",
                modifier: 0.8
            }
        ];

        // =========== FAST TRACK CARDS ===========
        const fastTrackCards = [
            {
                id: "floresta",
                nome: "Compre uma Floresta",
                descricao: "500 hectares de floresta preservada para ecoturismo.",
                tipo: "gasto",
                custo: 125000
            },
            {
                id: "carnaval",
                nome: "Festival de Carnaval",
                descricao: "Patrocine um bloco de carnaval para 5.000 pessoas.",
                tipo: "gasto",
                custo: 62500
            },
            {
                id: "cabana_pesca",
                nome: "Cabana de Pesca Exclusiva",
                descricao: "Cabana privativa em lago particular com helicóptero.",
                tipo: "gasto",
                custo: 50000
            },
            {
                id: "parque_nome",
                nome: "Parque com Seu Nome",
                descricao: "Parque público nomeado em sua homenagem.",
                tipo: "gasto",
                custo: 112500
            },
            {
                id: "franquia_frango",
                nome: "Franquia Internacional de Frango",
                descricao: "Rede de fast-food com 50 unidades.",
                tipo: "investimento",
                entrada: 150000,
                ccr: 40
            },
            {
                id: "camisetas",
                nome: "Cadeia de Lojas de Camisetas",
                descricao: "100 lojas em shoppings centers.",
                tipo: "investimento",
                entrada: 125000,
                fluxo: 25000
            },
            {
                id: "80_apart",
                nome: "80 Apartamentos Classe A",
                descricao: "Condomínio de luxo em área nobre.",
                tipo: "investimento",
                entrada: 150000,
                ccr: 30
            },
            {
                id: "auditoria",
                nome: "Auditoria Fiscal Federal",
                descricao: "Multa por irregularidades contábeis.",
                tipo: "penalidade"
            },
            {
                id: "processo",
                nome: "Processo Judicial por Danos Morais",
                descricao: "Ação movida por ex-funcionário.",
                tipo: "penalidade",
                custo: 50000
            }
        ];

        // =========== CONFIGURAÇÃO INICIAL ===========
        function initializeGame() {
            setupPlayerNames();
            
            document.getElementById('numPlayers').addEventListener('change', setupPlayerNames);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('rollDiceBtn').addEventListener('click', rollDice);
            document.getElementById('endTurnBtn').addEventListener('click', endTurn);
            document.getElementById('showAssetsBtn').addEventListener('click', showAssets);
            document.getElementById('takeLoanBtn').addEventListener('click', showLoanModal);
            document.getElementById('useProtectionBtn').addEventListener('click', useProtection);
            document.getElementById('newGameBtn').addEventListener('click', () => location.reload());
            
            showProfessionsInfo();
        }

        function setupPlayerNames() {
            const numPlayers = parseInt(document.getElementById('numPlayers').value);
            const container = document.getElementById('playerNamesContainer');
            container.innerHTML = '';
            
            for (let i = 1; i <= numPlayers; i++) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>Jogador ${i}:</label>
                    <input type="text" id="playerName${i}" value="Jogador ${i}" placeholder="Nome do jogador">
                `;
                container.appendChild(div);
            }
        }

        function getRandomProfession() {
            if (gameState.availableProfessions.length === 0) {
                gameState.availableProfessions = [...allProfessions];
            }
            
            const randomIndex = Math.floor(Math.random() * gameState.availableProfessions.length);
            const profession = gameState.availableProfessions[randomIndex];
            
            gameState.availableProfessions.splice(randomIndex, 1);
            
            return profession;
        }

        function getRandomDreamForPlayer(playerId) {
            if (!gameState.playerDreams[playerId]) {
                let availableDreams = allDreams.filter(dream => 
                    !Object.values(gameState.playerDreams).includes(dream)
                );
                
                if (availableDreams.length === 0) {
                    gameState.playerDreams = {};
                    availableDreams = [...allDreams];
                }
                
                const randomDream = availableDreams[Math.floor(Math.random() * availableDreams.length)];
                gameState.playerDreams[playerId] = randomDream;
            }
            
            return gameState.playerDreams[playerId];
        }

        function startGame() {
            const numPlayers = parseInt(document.getElementById('numPlayers').value);
            gameState.totalPlayers = numPlayers;
            gameState.players = {};
            gameState.currentRound = 1;
            gameState.totalLaps = 0;
            gameState.availableProfessions = [...allProfessions];
            gameState.playerDreams = {};
            gameState.nextDoodadProtected = false;
            gameState.protectedPlayer = null;
            
            for (let i = 1; i <= numPlayers; i++) {
                const name = document.getElementById(`playerName${i}`).value || `Jogador ${i}`;
                const prof = getRandomProfession();
                const dream = getRandomDreamForPlayer(i);
                
                // Calcular despesas totais
                const totalExpenses = prof.taxes + prof.mortgage + prof.carPayment + 
                                    prof.creditCard + prof.otherExpenses + prof.studentLoan;
                
                // NOVA REGRA: Dinheiro Inicial = 2 × Despesas Mensais
                const initialCash = totalExpenses * 2;
                
                gameState.players[i] = {
                    id: i,
                    name: name,
                    profession: prof.name,
                    salary: prof.salary,
                    initialCash: initialCash,
                    cash: initialCash,
                    passiveIncome: 0,
                    position: 0,
                    inRatRace: true,
                    children: 0,
                    maxChildren: 3,
                    perChildCost: prof.perChildCost,
                    expenses: totalExpenses,
                    cashflow: prof.salary - totalExpenses,
                    assets: {
                        stocks: [],
                        realEstate: [],
                        businesses: [],
                        bonds: [],
                        protection: null
                    },
                    loans: [],
                    liabilities: {
                        studentLoan: prof.studentLoan,
                        carLoan: prof.carPayment,
                        creditCard: prof.creditCard,
                        mortgage: prof.mortgage
                    },
                    hasCharityBonus: false,
                    lapsCompleted: 0,
                    dreams: [],
                    assignedDream: dream,
                    isDownsized: false,
                    downsizedRounds: 0
                };
            }
            
            createBoard();
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            
            updateBoard();
            updateCurrentPlayerInfo();
            updateGameStats();
            updateProtectionButton();
            
            addLog("🎮 JOGO INICIADO - CASHFLOW ORIGINAL!");
            addLog("💰 NOVA REGRA: Dinheiro Inicial = 2 × Despesas Mensais");
            
            for (let i = 1; i <= numPlayers; i++) {
                const player = gameState.players[i];
                addLog(`👤 ${player.name} é ${player.profession} (Salário: R$ ${player.salary.toLocaleString()}, Inicial: R$ ${player.cash.toLocaleString()})`);
                addLog(`💭 Sonho de ${player.name}: ${player.assignedDream}`);
            }
            addLog(`🎲 Vez de: ${gameState.players[1].name}`);
        }

        // =========== TABULEIRO ===========
        function createBoard() {
            gameState.spaces = [];
            
            const spaceTypes = [
                'start', 'opportunity', 'doodad', 'opportunity', 'market',
                'opportunity', 'payday', 'opportunity', 'downsized', 'opportunity',
                'doodad', 'opportunity', 'market', 'opportunity', 'payday',
                'opportunity', 'baby', 'opportunity', 'doodad', 'opportunity',
                'charity', 'opportunity', 'payday', 'opportunity', 'market'
            ];
            
            const spaceNames = [
                'INÍCIO', 'OPORTUNIDADE', 'DOODADS', 'OPORTUNIDADE', 'MERCADO',
                'OPORTUNIDADE', 'DIA DE PAGAMENTO', 'OPORTUNIDADE', 'DEMISSÃO', 'OPORTUNIDADE',
                'DOODADS', 'OPORTUNIDADE', 'MERCADO', 'OPORTUNIDADE', 'DIA DE PAGAMENTO',
                'OPORTUNIDADE', 'BEBÊ', 'OPORTUNIDADE', 'DOODADS', 'OPORTUNIDADE',
                'CARIDADE', 'OPORTUNIDADE', 'DIA DE PAGAMENTO', 'OPORTUNIDADE', 'MERCADO'
            ];
            
            const spaceActions = [
                'Comece aqui!', 'Compre Small Deal ou Big Deal', 'Gasto obrigatório!', 'Compre Small Deal ou Big Deal', 'Venda ou compre ativos',
                'Compre Small Deal ou Big Deal', 'Receba salário + renda passiva', 'Compre Small Deal ou Big Deal', 'Pague 1 mês de despesas', 'Compre Small Deal ou Big Deal',
                'Gasto obrigatório!', 'Compre Small Deal ou Big Deal', 'Venda ou compre ativos', 'Compre Small Deal ou Big Deal', 'Receba salário + renda passiva',
                'Compre Small Deal ou Big Deal', 'Despesas aumentam', 'Compre Small Deal ou Big Deal', 'Gasto obrigatório!', 'Compre Small Deal ou Big Deal',
                'Doação 10% do salário', 'Compre Small Deal ou Big Deal', 'Receba salário + renda passiva', 'Compre Small Deal ou Big Deal', 'Venda ou compre ativos'
            ];
            
            for (let i = 0; i < 25; i++) {
                gameState.spaces.push({
                    num: i + 1,
                    type: spaceTypes[i],
                    name: spaceNames[i],
                    action: spaceActions[i]
                });
            }
            
            const table = document.getElementById('boardTable');
            let html = `
                <thead>
                    <tr>
                        <th>ESPAÇO</th>
                        <th>TIPO</th>
                        <th>AÇÃO</th>
                        <th>JOGADORES</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            for (let i = 0; i < 25; i++) {
                const space = gameState.spaces[i];
                html += `
                    <tr class="space-${space.type}">
                        <td><span class="space-number">${space.num}</span></td>
                        <td><span class="space-type">${space.name}</span></td>
                        <td><span class="space-action">${space.action}</span></td>
                        <td id="spaceMarkers${i}" class="player-markers-cell">
                            <div class="player-markers" id="markers${i}"></div>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        function updateBoard() {
            for (let i = 0; i < 25; i++) {
                const markersDiv = document.getElementById(`markers${i}`);
                if (markersDiv) markersDiv.innerHTML = '';
            }
            
            for (let playerId = 1; playerId <= gameState.totalPlayers; playerId++) {
                const player = gameState.players[playerId];
                
                if (!player.inRatRace) continue;
                
                const markersDiv = document.getElementById(`markers${player.position}`);
                
                if (markersDiv) {
                    const marker = document.createElement('div');
                    marker.className = `player-marker color-${playerId}`;
                    marker.textContent = playerId;
                    marker.title = player.name;
                    markersDiv.appendChild(marker);
                }
            }
            
            updateFastTrackSection();
        }

        // =========== MOSTRAR INFORMAÇÕES DAS PROFISSÕES ===========
        function showProfessionsInfo() {
            const container = document.getElementById('professionsGrid');
            let html = '';
            
            allProfessions.forEach(prof => {
                const totalExpenses = prof.taxes + prof.mortgage + prof.carPayment + 
                                    prof.creditCard + prof.otherExpenses + prof.studentLoan;
                const initialCashflow = prof.salary - totalExpenses;
                
                const initialCashNewRule = totalExpenses * 2;
                
                html += `
                    <div class="profession-item">
                        <strong>${prof.name}</strong><br>
                        <small>Salário: R$ ${prof.salary.toLocaleString()}</small><br>
                        <small>Despesas: R$ ${totalExpenses.toLocaleString()}/mês</small><br>
                        <small>Inicial (2×): R$ ${initialCashNewRule.toLocaleString()}</small><br>
                        <small>Fluxo: R$ ${initialCashflow.toLocaleString()}/mês</small><br>
                        <small>Filho: R$ ${prof.perChildCost}/mês</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // =========== ATUALIZAR FAST TRACK SECTION ===========
        function updateFastTrackSection() {
            const section = document.getElementById('fastTrackSection');
            const content = document.getElementById('fastTrackContent');
            
            let fastTrackPlayers = [];
            for (let playerId = 1; playerId <= gameState.totalPlayers; playerId++) {
                if (!gameState.players[playerId].inRatRace) {
                    fastTrackPlayers.push(gameState.players[playerId]);
                }
            }
            
            if (fastTrackPlayers.length > 0) {
                section.style.display = 'block';
                
                let html = '';
                fastTrackPlayers.forEach(player => {
                    html += `
                        <div class="fast-track-card">
                            <div class="fast-track-header">
                                <span>${player.name}</span>
                                <span style="color: #2ecc71;">R$ ${player.passiveIncome.toLocaleString()}/mês</span>
                            </div>
                            <p>Saldo: R$ ${player.cash.toLocaleString()}</p>
                            <p><strong>Sonho:</strong> ${player.assignedDream}</p>
                            ${player.dreams.length > 0 ? `
                                <div style="margin-top: 10px;">
                                    <strong>Sonhos Realizados:</strong>
                                    ${player.dreams.map(dream => `
                                        <div class="dream-achieved">${dream}</div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                content.innerHTML = html;
            } else {
                section.style.display = 'none';
            }
            
            document.getElementById('fastTrackCount').textContent = fastTrackPlayers.length;
        }

        // =========== ATUALIZAR ESTATÍSTICAS DO JOGO ===========
        function updateGameStats() {
            document.getElementById('currentRound').textContent = gameState.currentRound;
            
            let fastTrackCount = 0;
            for (let playerId = 1; playerId <= gameState.totalPlayers; playerId++) {
                if (!gameState.players[playerId].inRatRace) {
                    fastTrackCount++;
                }
            }
            
            document.getElementById('fastTrackCount').textContent = fastTrackCount;
            
            if (fastTrackCount === gameState.totalPlayers) {
                document.getElementById('gameStatus').textContent = "TODOS NO FAST TRACK";
                document.getElementById('gameStatus').style.color = "#9b59b6";
            } else if (fastTrackCount > 0) {
                document.getElementById('gameStatus').textContent = "FAST TRACK ATIVO";
                document.getElementById('gameStatus').style.color = "#9b59b6";
            } else {
                document.getElementById('gameStatus').textContent = "CORRIDA DOS RATOS";
                document.getElementById('gameStatus').style.color = "#f39c12";
            }
        }

        // =========== ATUALIZAR INFORMAÇÕES DO JOGADOR ===========
        function updateCurrentPlayerInfo() {
            const player = gameState.players[gameState.currentPlayer];
            const infoBar = document.getElementById('currentPlayerInfo');
            
            const childExpenses = player.children * player.perChildCost;
            const totalExpenses = player.expenses + childExpenses;
            
            let totalLoans = 0;
            player.loans.forEach(loan => {
                totalLoans += loan.amount;
            });
            
            let html = `
                <div class="player-info-item">
                    <div class="info-label">JOGADOR ATUAL</div>
                    <div class="info-value" style="color: var(--player${player.id})">
                        ${player.name}
                    </div>
                </div>
                
                <div class="player-info-item">
                    <div class="info-label">PROFISSÃO</div>
                    <div class="info-value">${player.profession}</div>
                </div>
                
                <div class="player-info-item">
                    <div class="info-label">DINHEIRO</div>
                    <div class="info-value info-income">R$ ${player.cash.toLocaleString()}</div>
                </div>
                
                <div class="player-info-item">
                    <div class="info-label">RENDA PASSIVA</div>
                    <div class="info-value info-income">R$ ${player.passiveIncome.toLocaleString()}/mês</div>
                </div>
                
                <div class="player-info-item">
                    <div class="info-label">DESPESAS TOTAIS</div>
                    <div class="info-value info-expense">R$ ${totalExpenses.toLocaleString()}/mês</div>
                </div>
                
                <div class="player-info-item">
                    <div class="info-label">FLUXO DE CAIXA</div>
                    <div class="info-value" style="color: ${player.salary + player.passiveIncome - totalExpenses >= 0 ? '#2ecc71' : '#e74c3c'}">
                        R$ ${(player.salary + player.passiveIncome - totalExpenses).toLocaleString()}/mês
                    </div>
                </div>
            `;
            
            if (player.children > 0) {
                html += `
                    <div class="player-info-item">
                        <div class="info-label">FILHOS</div>
                        <div class="info-value">${player.children} (R$ ${childExpenses}/mês)</div>
                    </div>
                `;
            }
            
            if (totalLoans > 0) {
                html += `
                    <div class="player-info-item">
                        <div class="info-label">EMPRÉSTIMOS</div>
                        <div class="info-value info-warning">R$ ${totalLoans.toLocaleString()}</div>
                    </div>
                `;
            }
            
            if (player.assets.protection) {
                html += `
                    <div class="player-info-item">
                        <div class="info-label">PROTEÇÃO</div>
                        <div class="info-value info-protection">
                            <i class="fas fa-shield-alt"></i> ATIVA
                        </div>
                    </div>
                `;
            }
            
            if (player.isDownsized) {
                html += `
                    <div class="player-info-item" style="grid-column: 1 / -1;">
                        <div class="info-value info-warning">
                            <i class="fas fa-exclamation-triangle"></i> DEMITIDO (${player.downsizedRounds}/2 rodadas)
                        </div>
                    </div>
                `;
            }
            
            if (!player.inRatRace) {
                html += `
                    <div class="player-info-item" style="grid-column: 1 / -1;">
                        <div class="info-value" style="color: #9b59b6;">
                            🚀 VIA RÁPIDA (FAST TRACK)
                        </div>
                    </div>
                    <div class="player-info-item" style="grid-column: 1 / -1;">
                        <div class="info-label">SONHO</div>
                        <div class="info-value" style="color: #f39c12;">${player.assignedDream}</div>
                    </div>
                `;
            }
            
            infoBar.innerHTML = html;
        }

        // =========== ATUALIZAR BOTÃO DE PROTEÇÃO ===========
        function updateProtectionButton() {
            const player = gameState.players[gameState.currentPlayer];
            const protectionBtn = document.getElementById('useProtectionBtn');
            
            if (player.assets.protection) {
                protectionBtn.style.display = 'inline-flex';
                protectionBtn.disabled = false;
                protectionBtn.innerHTML = '<i class="fas fa-shield-alt"></i> USAR PROTEÇÃO';
            } else {
                protectionBtn.style.display = 'none';
            }
        }

        // =========== USAR PROTEÇÃO ===========
        function useProtection() {
            const player = gameState.players[gameState.currentPlayer];
            
            if (!player.assets.protection) {
                alert("Você não possui proteção!");
                return;
            }
            
            gameState.nextDoodadProtected = true;
            gameState.protectedPlayer = player.id;
            
            player.assets.protection = null;
            
            addLog(`🛡️ ${player.name} ativou proteção! Próximo Doodad será anulado.`);
            
            updateProtectionButton();
            updateCurrentPlayerInfo();
            
            document.getElementById('useProtectionBtn').style.display = 'none';
        }

        // =========== SISTEMA DE EMPRÉSTIMOS ===========
        function showLoanModal() {
            const player = gameState.players[gameState.currentPlayer];
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--dark); margin-bottom: 10px;">Solicitar Empréstimo</h3>
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                            <span style="color: #666;">Saldo Disponível:</span>
                            <span style="font-weight: bold; color: var(--dark);">R$ ${player.cash.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                            <span style="color: #666;">Total de Empréstimos:</span>
                            <span style="font-weight: bold; color: #e74c3c;">R$ ${player.loans.reduce((sum, loan) => sum + loan.amount, 0).toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                            <span style="color: #666;">Juros do Banco:</span>
                            <span style="font-weight: bold; color: #e74c3c;">10% ao mês</span>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: var(--dark); margin-bottom: 15px;">Valores Disponíveis:</h3>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
            `;
            
            const loanAmounts = [1000, 5000, 10000, 20000, 50000, 100000];
            
            loanAmounts.forEach(amount => {
                const monthlyPayment = amount * 0.1;
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer;" 
                         onclick="takeLoan(${amount})">
                        <div style="font-weight: bold; font-size: 1.2rem; color: var(--dark);">
                            R$ ${amount.toLocaleString()}
                        </div>
                        <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                            Pagamento: R$ ${monthlyPayment.toLocaleString()}/mês
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="text-align: center; padding: 15px; background: #e74c3c10; border-radius: 8px; margin-top: 20px;">
                    <p style="color: #666; font-size: 0.9rem;">
                        <i class="fas fa-exclamation-triangle"></i> Atenção: Os empréstimos têm juros de 10% ao mês. 
                        O pagamento é deduzido automaticamente no Dia de Pagamento.
                    </p>
                </div>
            `;
            
            document.getElementById('loanContent').innerHTML = html;
            document.getElementById('loanModal').style.display = 'flex';
        }

        function takeLoan(amount) {
            const player = gameState.players[gameState.currentPlayer];
            
            player.loans.push({
                amount: amount,
                interestRate: 0.1,
                monthlyPayment: amount * 0.1,
                takenAt: Date.now()
            });
            
            player.cash += amount;
            player.expenses += amount * 0.1;
            player.cashflow = player.salary + player.passiveIncome - player.expenses;
            
            addLog(`🏦 ${player.name} pegou empréstimo de R$ ${amount.toLocaleString()} (pagamento: R$ ${(amount * 0.1).toLocaleString()}/mês)`);
            
            closeModal('loanModal');
            updateCurrentPlayerInfo();
        }

        // =========== SISTEMA DE DADOS SIMPLIFICADO ===========
        function rollDice() {
            if (!gameState.gameActive) {
                alert("O jogo não está ativo!");
                return;
            }
            
            const player = gameState.players[gameState.currentPlayer];
            
            if (!player.inRatRace) {
                showFastTrackOpportunity();
                return;
            }
            
            const rollBtn = document.getElementById('rollDiceBtn');
            rollBtn.disabled = true;
            
            const dice1 = document.getElementById('dice1');
            const dice2 = document.getElementById('dice2');
            
            dice1.style.display = 'flex';
            dice2.style.display = 'none';
            
            dice1.classList.add('rolling');
            
            setTimeout(() => {
                const dice1Value = Math.floor(Math.random() * 6) + 1;
                let total = dice1Value;
                
                // Verificar se tem bônus de caridade para rolar 2 dados
                if (gameState.dice3Enabled && gameState.charityPlayer === gameState.currentPlayer) {
                    dice2.style.display = 'flex';
                    dice2.classList.add('rolling');
                    
                    setTimeout(() => {
                        const dice2Value = Math.floor(Math.random() * 6) + 1;
                        dice2.textContent = dice2Value;
                        dice2.classList.remove('rolling');
                        
                        total = dice1Value + dice2Value;
                        
                        addLog(`🎲 ${player.name} rolou 2 dados (caridade): ${dice1Value}+${dice2Value}=${total}`);
                        
                        gameState.charityRoundsLeft--;
                        
                        if (gameState.charityRoundsLeft <= 0) {
                            gameState.dice3Enabled = false;
                            gameState.charityPlayer = null;
                            dice2.style.display = 'none';
                            addLog(`🙏 Bônus de caridade de ${player.name} terminou`);
                        } else {
                            addLog(`🙏 ${player.name} ainda tem ${gameState.charityRoundsLeft} rodada(s) com bônus de caridade`);
                        }
                        
                        dice1.textContent = dice1Value;
                        dice1.classList.remove('rolling');
                        
                        movePlayer(gameState.currentPlayer, total);
                        document.getElementById('endTurnBtn').disabled = false;
                        
                        // Mostrar carta automaticamente após mover
                        setTimeout(() => {
                            showCardForSpace(player.position);
                        }, 500);
                        
                    }, 800);
                } else {
                    addLog(`🎲 ${player.name} rolou ${dice1Value}=${total}`);
                    
                    dice1.textContent = dice1Value;
                    dice1.classList.remove('rolling');
                    
                    movePlayer(gameState.currentPlayer, total);
                    document.getElementById('endTurnBtn').disabled = false;
                    
                    // Mostrar carta automaticamente após mover
                    setTimeout(() => {
                        showCardForSpace(player.position);
                    }, 500);
                }
                
            }, 800);
        }

        function movePlayer(playerId, steps) {
            const player = gameState.players[playerId];
            const oldPosition = player.position;
            
            let newPosition = (player.position + steps) % 25;
            
            if (newPosition < oldPosition && steps > 0) {
                player.lapsCompleted++;
                gameState.totalLaps = Math.max(gameState.totalLaps, player.lapsCompleted);
                
                payday(playerId);
                
                addLog(`🔄 ${player.name} completou uma volta! Total: ${player.lapsCompleted} volta(s)`);
            }
            
            player.position = newPosition;
            updateBoard();
            updateCurrentPlayerInfo();
            updateGameStats();
        }

        // =========== FUNÇÃO PARA MOSTRAR CARTA DO ESPAÇO ===========
        function showCardForSpace(position) {
            const space = gameState.spaces[position];
            
            addLog(`📍 ${gameState.players[gameState.currentPlayer].name} está no espaço ${space.num}: ${space.name}`);
            
            setTimeout(() => {
                switch(space.type) {
                    case 'payday':
                        payday(gameState.currentPlayer);
                        break;
                    case 'baby':
                        haveBaby(gameState.currentPlayer);
                        break;
                    case 'charity':
                        charity(gameState.currentPlayer);
                        break;
                    case 'downsized':
                        downsized(gameState.currentPlayer);
                        break;
                    case 'opportunity':
                        const isSmallDeal = Math.random() < 0.7;
                        if (isSmallDeal) {
                            showSmallDeal(gameState.currentPlayer);
                        } else {
                            showBigDeal(gameState.currentPlayer);
                        }
                        break;
                    case 'doodad':
                        showDoodadCard(gameState.currentPlayer);
                        break;
                    case 'market':
                        showMarketCard(gameState.currentPlayer);
                        break;
                }
            }, 500);
        }

        // =========== OPORTUNIDADES ALEATÓRIAS ===========
        function showSmallDeal(playerId) {
            const card = smallDealCards[Math.floor(Math.random() * smallDealCards.length)];
            gameState.currentCard = { ...card, playerId: playerId, cardType: 'small' };
            
            const display = document.getElementById('cardDisplay');
            const title = document.getElementById('cardTitle');
            const typeTag = document.getElementById('cardTypeTag');
            const description = document.getElementById('cardDescription');
            const details = document.getElementById('cardDetails');
            const actions = document.getElementById('cardActions');
            
            title.textContent = card.name;
            typeTag.textContent = 'PEQUENA OPORTUNIDADE';
            typeTag.style.backgroundColor = '#3498db';
            description.textContent = card.description;
            
            if (card.type === 'proteção') {
                details.innerHTML = `
                    <div class="card-detail">
                        <div class="detail-label">Tipo</div>
                        <div class="detail-value">Proteção Financeira</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Efeito</div>
                        <div class="detail-value">Anula o próximo Doodad</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Custo</div>
                        <div class="detail-value">R$ ${card.cost.toLocaleString()}</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Duração</div>
                        <div class="detail-value">Uso único</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Regra</div>
                        <div class="detail-value">Máximo 1 por jogador</div>
                    </div>
                `;
                
                actions.innerHTML = `
                    <button class="button button-protection" onclick="buyAsset()">
                        <i class="fas fa-shield-alt"></i> COMPRAR PROTEÇÃO
                    </button>
                    <button class="button" onclick="declineCard()">
                        <i class="fas fa-times"></i> RECUSAR
                    </button>
                `;
                
            } else if (card.type === 'ações') {
                details.innerHTML = `
                    <div class="card-detail">
                        <div class="detail-label">Tipo</div>
                        <div class="detail-value">Ações</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Preço por Ação</div>
                        <div class="detail-value">R$ ${card.costPerShare.toLocaleString()}</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Quantidade Mínima</div>
                        <div class="detail-value">${card.shares} ações</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Investimento Mínimo</div>
                        <div class="detail-value">R$ ${card.downPayment.toLocaleString()}</div>
                    </div>
                    ${card.cashflow > 0 ? `
                    <div class="card-detail">
                        <div class="detail-label">Dividendo Mensal</div>
                        <div class="detail-value" style="color: #2ecc71;">R$ ${card.cashflow}</div>
                    </div>
                    ` : ''}
                    ${card.roi ? `
                    <div class="card-detail">
                        <div class="detail-label">Potencial de Venda</div>
                        <div class="detail-value" style="color: #f39c12;">${card.roi}</div>
                    </div>
                    ` : ''}
                `;
                
                actions.innerHTML = `
                    <button class="button button-success" onclick="buyAsset()">
                        <i class="fas fa-check"></i> COMPRAR
                    </button>
                    <button class="button" onclick="declineCard()">
                        <i class="fas fa-times"></i> RECUSAR
                    </button>
                `;
            } else {
                // Para títulos/FII com juros anuais
                let monthlyReturn = 0;
                if (card.annualReturn) {
                    const investmentValue = card.cost || card.downPayment;
                    monthlyReturn = (investmentValue * (card.annualReturn / 100)) / 12;
                } else {
                    monthlyReturn = card.cashflow || 0;
                }
                
                details.innerHTML = `
                    <div class="card-detail">
                        <div class="detail-label">Tipo</div>
                        <div class="detail-value">${card.type === 'títulos' ? 'Títulos' : 'Fundo Imobiliário'}</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Investimento Mínimo</div>
                        <div class="detail-value">R$ ${card.downPayment.toLocaleString()}</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Renda por Payday</div>
                        <div class="detail-value" style="color: #2ecc71;">R$ ${monthlyReturn.toFixed(2)}</div>
                    </div>
                    ${card.annualReturn ? `
                    <div class="card-detail">
                        <div class="detail-label">Taxa Anual</div>
                        <div class="detail-value" style="color: #f39c12;">${card.annualReturn}% ao ano</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Conversão</div>
                        <div class="detail-value" style="color: #3498db;">${(card.annualReturn/12).toFixed(2)}% por Payday</div>
                    </div>
                    ` : ''}
                    ${card.roi ? `
                    <div class="card-detail">
                        <div class="detail-label">Informação</div>
                        <div class="detail-value" style="color: #666;">${card.roi}</div>
                    </div>
                    ` : ''}
                `;
                
                actions.innerHTML = `
                    <button class="button button-success" onclick="buyAsset()">
                        <i class="fas fa-check"></i> COMPRAR
                    </button>
                    <button class="button" onclick="declineCard()">
                        <i class="fas fa-times"></i> RECUSAR
                    </button>
                `;
            }
            
            display.style.display = 'block';
        }

        function showBigDeal(playerId) {
            const player = gameState.players[playerId];
            let availableCards = [...bigDealCards];
            
            availableCards = availableCards.filter(card => {
                if (!card.requires) return true;
                
                if (card.requires === "1 volta completa") {
                    return player.lapsCompleted >= 1;
                }
                
                if (card.requires.includes("renda passiva mínima")) {
                    const minIncome = parseInt(card.requires.match(/R\$ (\d+)/)[1]);
                    return player.passiveIncome >= minIncome;
                }
                
                if (card.requires.includes("OU")) {
                    const conditions = card.requires.split(" OU ");
                    return conditions.some(condition => {
                        if (condition === "1 volta completa") {
                            return player.lapsCompleted >= 1;
                        }
                        if (condition.includes("renda passiva mínima")) {
                            const minIncome = parseInt(condition.match(/R\$ (\d+)/)[1]);
                            return player.passiveIncome >= minIncome;
                        }
                        return false;
                    });
                }
                
                return true;
            });
            
            if (availableCards.length === 0) {
                showSmallDeal(playerId);
                return;
            }
            
            const card = availableCards[Math.floor(Math.random() * availableCards.length)];
            gameState.currentCard = { ...card, playerId: playerId, cardType: 'big' };
            
            const display = document.getElementById('cardDisplay');
            const title = document.getElementById('cardTitle');
            const typeTag = document.getElementById('cardTypeTag');
            const description = document.getElementById('cardDescription');
            const details = document.getElementById('cardDetails');
            const actions = document.getElementById('cardActions');
            
            title.textContent = card.name;
            typeTag.textContent = 'GRANDE OPORTUNIDADE';
            typeTag.style.backgroundColor = '#e67e22';
            description.textContent = card.description;
            
            let monthlyCashflow = card.cashflow || 0;
            if (card.annualReturn) {
                const investmentValue = card.cost || card.downPayment;
                monthlyCashflow = (investmentValue * (card.annualReturn / 100)) / 12;
            }
            
            details.innerHTML = `
                <div class="card-detail">
                    <div class="detail-label">Tipo</div>
                    <div class="detail-value">${card.type === 'imóvel' ? 'Imóvel' : 'Negócio'}</div>
                </div>
                <div class="card-detail">
                    <div class="detail-label">Valor Total</div>
                    <div class="detail-value">R$ ${card.cost ? card.cost.toLocaleString() : card.downPayment.toLocaleString()}</div>
                </div>
                <div class="card-detail">
                    <div class="detail-label">Entrada Necessária</div>
                    <div class="detail-value">R$ ${card.downPayment.toLocaleString()}</div>
                </div>
                ${card.mortgage ? `
                <div class="card-detail">
                    <div class="detail-label">Financiamento</div>
                    <div class="detail-value">R$ ${card.mortgage.toLocaleString()}</div>
                </div>
                ` : ''}
                <div class="card-detail">
                    <div class="detail-label">Renda por Payday</div>
                    <div class="detail-value" style="color: #2ecc71;">R$ ${monthlyCashflow.toFixed(2)}</div>
                </div>
                ${card.annualReturn ? `
                <div class="card-detail">
                    <div class="detail-label">Taxa Anual</div>
                    <div class="detail-value" style="color: #f39c12;">${card.annualReturn}% ao ano</div>
                </div>
                <div class="card-detail">
                    <div class="detail-label">Conversão</div>
                    <div class="detail-value" style="color: #3498db;">${(card.annualReturn/12).toFixed(2)}% por Payday</div>
                </div>
                ` : ''}
                ${card.roi ? `
                <div class="card-detail">
                    <div class="detail-label">Retorno</div>
                    <div class="detail-value" style="color: #f39c12;">${card.roi}</div>
                </div>
                ` : ''}
                ${card.requires ? `
                <div class="card-detail">
                    <div class="detail-label">Pré-requisito</div>
                    <div class="detail-value" style="color: #3498db;">${card.requires}</div>
                </div>
                ` : ''}
            `;
            
            actions.innerHTML = `
                <button class="button button-success" onclick="buyAsset()">
                    <i class="fas fa-check"></i> COMPRAR
                </button>
                <button class="button" onclick="declineCard()">
                    <i class="fas fa-times"></i> RECUSAR
                </button>
            `;
            
            display.style.display = 'block';
        }

        // =========== COMPRAR ATIVOS ===========
        function buyAsset() {
            const card = gameState.currentCard;
            const player = gameState.players[card.playerId];
            
            if (player.cash < card.downPayment) {
                if (confirm(`Dinheiro insuficiente! Você tem R$ ${player.cash.toLocaleString()}, precisa de R$ ${card.downPayment.toLocaleString()}.\n\nDeseja pegar um empréstimo?`)) {
                    showLoanModal();
                }
                return;
            }
            
            player.cash -= card.downPayment;
            
            if (card.type === 'proteção') {
                if (player.assets.protection) {
                    alert("Você já possui uma proteção ativa! Máximo 1 por jogador.");
                    player.cash += card.downPayment;
                    return;
                }
                
                player.assets.protection = {
                    name: card.name,
                    description: card.description,
                    active: true
                };
                
                addLog(`🛡️ ${player.name} comprou ${card.name} por R$ ${card.downPayment.toLocaleString()}`);
                updateProtectionButton();
                
            } else if (card.type === 'ações') {
                player.passiveIncome += card.cashflow || 0;
                
                let specialRules = "";
                if (card.name.includes("ON2U")) {
                    specialRules = "Venda somente em mercado de ações | Risco: perde 50% em baixa";
                } else if (card.name.includes("MYT4U")) {
                    specialRules = "Venda limitada a 50% por evento de mercado";
                }
                
                player.assets.stocks.push({
                    name: card.name,
                    shares: card.shares,
                    costPerShare: card.costPerShare,
                    cashflow: card.cashflow || 0,
                    roi: card.roi || "",
                    specialRules: specialRules,
                    purchasePrice: card.downPayment,
                    canSell: false
                });
                
                addLog(`✅ ${player.name} comprou ${card.name} por R$ ${card.downPayment.toLocaleString()} ${card.cashflow ? `(renda: +R$ ${card.cashflow}/mês)` : ''}`);
                
            } else if (card.type === 'imóvel') {
                // Calcular renda mensal (se for anual, converter)
                let monthlyCashflow = card.cashflow || 0;
                
                // Se tiver annualReturn, calcular renda mensal
                if (card.annualReturn) {
                    const investmentValue = card.cost || card.downPayment;
                    monthlyCashflow = (investmentValue * (card.annualReturn / 100)) / 12;
                    addLog(`📊 ${card.name}: ${card.annualReturn}% ao ano convertido para ${(card.annualReturn/12).toFixed(2)}% por Payday`);
                }
                
                player.passiveIncome += monthlyCashflow;
                player.assets.realEstate.push({
                    name: card.name,
                    cost: card.cost,
                    downPayment: card.downPayment,
                    mortgage: card.mortgage || 0,
                    cashflow: monthlyCashflow,
                    roi: card.roi || "",
                    annualReturn: card.annualReturn || 0
                });
                
                addLog(`✅ ${player.name} comprou ${card.name} por R$ ${card.downPayment.toLocaleString()} (renda: +R$ ${monthlyCashflow.toFixed(2)}/mês)`);
                
            } else if (card.type === 'negócio') {
                let monthlyCashflow = card.cashflow || 0;
                
                // Se tiver annualReturn, calcular renda mensal
                if (card.annualReturn) {
                    const investmentValue = card.cost || card.downPayment;
                    monthlyCashflow = (investmentValue * (card.annualReturn / 100)) / 12;
                    addLog(`📊 ${card.name}: ${card.annualReturn}% ao ano convertido para ${(card.annualReturn/12).toFixed(2)}% por Payday`);
                }
                
                player.passiveIncome += monthlyCashflow;
                player.assets.businesses.push({
                    name: card.name,
                    cost: card.cost,
                    downPayment: card.downPayment,
                    mortgage: card.mortgage || 0,
                    cashflow: monthlyCashflow,
                    roi: card.roi || "",
                    annualReturn: card.annualReturn || 0
                });
                
                addLog(`✅ ${player.name} comprou ${card.name} por R$ ${card.downPayment.toLocaleString()} (renda: +R$ ${monthlyCashflow.toFixed(2)}/mês)`);
                
            } else if (card.type === 'títulos' || card.type === 'fii') {
                let monthlyCashflow = card.cashflow || 0;
                
                // Se tiver annualReturn, calcular renda mensal
                if (card.annualReturn) {
                    const investmentValue = card.cost || card.downPayment;
                    monthlyCashflow = (investmentValue * (card.annualReturn / 100)) / 12;
                    addLog(`📊 ${card.name}: ${card.annualReturn}% ao ano convertido para ${(card.annualReturn/12).toFixed(2)}% por Payday`);
                }
                
                player.passiveIncome += monthlyCashflow;
                player.assets.bonds.push({
                    name: card.name,
                    cost: card.cost || card.downPayment,
                    cashflow: monthlyCashflow,
                    roi: card.roi || "",
                    annualReturn: card.annualReturn || 0
                });
                
                addLog(`✅ ${player.name} comprou ${card.name} por R$ ${card.downPayment.toLocaleString()} (renda: +R$ ${monthlyCashflow.toFixed(2)}/mês)`);
            }
            
            checkExitRatRace(card.playerId);
            
            document.getElementById('cardDisplay').style.display = 'none';
            updateCurrentPlayerInfo();
        }

        // =========== DOODAD COM ESCALONAMENTO ===========
        function showDoodadCard(playerId) {
            const player = gameState.players[playerId];
            
            // Verificar proteção
            if (gameState.nextDoodadProtected && gameState.protectedPlayer === playerId) {
                addLog(`🛡️ ${player.name} usou proteção! Doodad anulado.`);
                gameState.nextDoodadProtected = false;
                gameState.protectedPlayer = null;
                return;
            }
            
            // Determinar categoria baseado nas voltas
            let doodadCategory;
            if (player.lapsCompleted <= 5) {
                doodadCategory = "voltas_1_5";
            } else if (player.lapsCompleted <= 10) {
                doodadCategory = "voltas_6_10";
            } else if (player.lapsCompleted <= 15) {
                doodadCategory = "voltas_11_15";
            } else if (player.lapsCompleted <= 20) {
                doodadCategory = "voltas_16_20";
            } else {
                doodadCategory = "voltas_21_mais";
            }
            
            // Sortear doodad da categoria apropriada
            const availableDoodads = doodadCardsByLaps[doodadCategory];
            const card = availableDoodads[Math.floor(Math.random() * availableDoodads.length)];
            
            addLog(`📊 ${player.name} está na categoria ${doodadCategory.replace('_', ' ')} (${player.lapsCompleted} voltas)`);
            
            gameState.currentCard = { ...card, playerId: playerId, cardType: 'doodad' };
            
            const display = document.getElementById('cardDisplay');
            const title = document.getElementById('cardTitle');
            const typeTag = document.getElementById('cardTypeTag');
            const description = document.getElementById('cardDescription');
            const details = document.getElementById('cardDetails');
            const actions = document.getElementById('cardActions');
            
            title.textContent = card.name;
            typeTag.textContent = 'DOODAD';
            typeTag.style.backgroundColor = '#e74c3c';
            description.textContent = card.description;
            
            details.innerHTML = `
                <div class="card-detail">
                    <div class="detail-label">Tipo</div>
                    <div class="detail-value">Despesa Obrigatória</div>
                </div>
                <div class="card-detail">
                    <div class="detail-label">Categoria</div>
                    <div class="detail-value">${doodadCategory.replace('_', ' ')}</div>
                </div>
                <div class="card-detail">
                    <div class="detail-label">Suas Voltas</div>
                    <div class="detail-value">${player.lapsCompleted}</div>
                </div>
                <div class="card-detail">
                    <div class="detail-label">Custo</div>
                    <div class="detail-value" style="color: #e74c3c;">R$ ${card.cost.toLocaleString()}</div>
                </div>
                <div class="card-detail">
                    <div class="detail-label">Regra</div>
                    <div class="detail-value">Escalonado por voltas no tabuleiro</div>
                </div>
            `;
            
            actions.innerHTML = `
                <button class="button button-danger" onclick="payDoodad()">
                    <i class="fas fa-check"></i> PAGAR
                </button>
            `;
            
            display.style.display = 'block';
        }

        function payDoodad() {
            const card = gameState.currentCard;
            const player = gameState.players[card.playerId];
            
            if (player.cash >= card.cost) {
                player.cash -= card.cost;
                addLog(`💸 ${player.name} pagou R$ ${card.cost.toLocaleString()} por ${card.name}`);
            } else {
                if (confirm(`Dinheiro insuficiente! Você precisa de R$ ${card.cost.toLocaleString()}.\n\nDeseja pegar um empréstimo?`)) {
                    showLoanModal();
                }
                return;
            }
            
            document.getElementById('cardDisplay').style.display = 'none';
            updateCurrentPlayerInfo();
        }

        // =========== MERCADO COM REGRAS ESPECIAIS ===========
        function showMarketCard(playerId) {
            const card = marketCards[Math.floor(Math.random() * marketCards.length)];
            gameState.currentCard = { ...card, playerId: playerId, cardType: 'market' };
            gameState.marketEvent = card;
            
            const display = document.getElementById('cardDisplay');
            const title = document.getElementById('cardTitle');
            const typeTag = document.getElementById('cardTypeTag');
            const description = document.getElementById('cardDescription');
            const details = document.getElementById('cardDetails');
            const actions = document.getElementById('cardActions');
            
            title.textContent = card.name;
            typeTag.textContent = 'MERCADO';
            typeTag.style.backgroundColor = card.type === 'alta' ? '#2ecc71' : '#e74c3c';
            description.textContent = card.description;
            
            const variation = ((card.modifier - 1) * 100).toFixed(0);
            
            details.innerHTML = `
                <div class="card-detail">
                    <div class="detail-label">Tipo de Mercado</div>
                    <div class="detail-value" style="color: ${card.type === 'alta' ? '#2ecc71' : '#e74c3c'}">
                        ${card.type === 'alta' ? 'ALTA' : 'BAIXA'}
                    </div>
                </div>
                <div class="card-detail">
                    <div class="detail-label">Afeta</div>
                    <div class="detail-value">${card.assetType === 'imóvel' ? 'IMÓVEIS' : card.assetType === 'ações' ? 'AÇÕES' : 'TÍTULOS'}</div>
                </div>
                <div class="card-detail">
                    <div class="detail-label">Variação de Preço</div>
                    <div class="detail-value" style="color: ${card.modifier > 1 ? '#2ecc71' : '#e74c3c'}">
                        ${variation > 0 ? '+' : ''}${variation}%
                    </div>
                </div>
            `;
            
            if (card.type === 'alta') {
                if (card.assetType === 'imóvel') {
                    actions.innerHTML = `
                        <button class="button button-success" onclick="showSellRealEstateModal(${playerId})">
                            <i class="fas fa-home"></i> VENDER IMÓVEIS
                        </button>
                        <button class="button" onclick="declineCard()">
                            <i class="fas fa-times"></i> MANTER ATIVOS
                        </button>
                    `;
                } else if (card.assetType === 'ações') {
                    actions.innerHTML = `
                        <button class="button button-success" onclick="showSellStocksModal(${playerId})">
                            <i class="fas fa-chart-line"></i> VENDER AÇÕES
                        </button>
                        <button class="button" onclick="declineCard()">
                            <i class="fas fa-times"></i> MANTER ATIVOS
                        </button>
                    `;
                } else {
                    actions.innerHTML = `
                        <button class="button" onclick="declineCard()">
                            <i class="fas fa-check"></i> ENTENDI
                        </button>
                    `;
                }
            } else {
                if (card.assetType === 'ações') {
                    const player = gameState.players[playerId];
                    let lostStocks = false;
                    
                    player.assets.stocks.forEach(stock => {
                        if (stock.name.includes("ON2U")) {
                            const lostShares = Math.floor(stock.shares * 0.5);
                            if (lostShares > 0) {
                                stock.shares -= lostShares;
                                lostStocks = true;
                                addLog(`📉 ${player.name} perdeu ${lostShares} ações ON2U em queda do mercado`);
                            }
                        }
                    });
                    
                    if (lostStocks) {
                        actions.innerHTML = `
                            <button class="button button-danger" onclick="declineCard()">
                                <i class="fas fa-exclamation-triangle"></i> ACEITAR PERDAS
                            </button>
                        `;
                    } else {
                        actions.innerHTML = `
                            <button class="button" onclick="declineCard()">
                                <i class="fas fa-check"></i> ENTENDI
                            </button>
                        `;
                    }
                } else {
                    actions.innerHTML = `
                        <button class="button" onclick="declineCard()">
                            <i class="fas fa-check"></i> ENTENDI
                        </button>
                    `;
                }
            }
            
            display.style.display = 'block';
        }

        // =========== MODAL PARA VENDA DE IMÓVEIS ===========
        function showSellRealEstateModal(playerId) {
            const player = gameState.players[playerId];
            const marketCard = gameState.marketEvent;
            
            if (player.assets.realEstate.length === 0) {
                alert("Você não possui imóveis para vender.");
                declineCard();
                return;
            }
            
            let html = '<p>Selecione quais imóveis deseja vender:</p>';
            
            player.assets.realEstate.forEach((asset, index) => {
                const saleValue = Math.round(asset.cost * marketCard.modifier);
                const profit = saleValue - asset.cost;
                
                html += `
                    <div class="asset-item">
                        <div class="asset-info">
                            <strong>${asset.name}</strong><br>
                            <small>Valor original: R$ ${asset.cost.toLocaleString()}</small><br>
                            <small>Valor de venda: R$ ${saleValue.toLocaleString()} (${profit > 0 ? '+' : ''}R$ ${profit.toLocaleString()})</small><br>
                            <small>Renda mensal: R$ ${asset.cashflow}</small>
                        </div>
                        <div class="sell-checkbox">
                            <input type="checkbox" id="realEstate${index}" data-index="${index}" data-value="${saleValue}" data-cashflow="${asset.cashflow}">
                            <label for="realEstate${index}">Vender</label>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('sellAssetsContent').innerHTML = html;
            document.getElementById('sellAssetsModal').style.display = 'flex';
        }

        function confirmSellAssets() {
            const player = gameState.players[gameState.currentCard.playerId];
            const checkboxes = document.querySelectorAll('#sellAssetsContent input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert("Selecione pelo menos um imóvel para vender.");
                return;
            }
            
            const indicesToRemove = [];
            let totalCash = 0;
            let totalCashflowReduction = 0;
            
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                const saleValue = parseInt(checkbox.dataset.value);
                const cashflow = parseInt(checkbox.dataset.cashflow);
                
                indicesToRemove.push({ index, saleValue, cashflow });
            });
            
            indicesToRemove.sort((a, b) => b.index - a.index);
            
            indicesToRemove.forEach(item => {
                const asset = player.assets.realEstate[item.index];
                player.cash += item.saleValue;
                player.passiveIncome -= item.cashflow;
                totalCash += item.saleValue;
                totalCashflowReduction += item.cashflow;
                
                addLog(`💰 ${player.name} vendeu ${asset.name} por R$ ${item.saleValue.toLocaleString()}`);
                
                player.assets.realEstate.splice(item.index, 1);
            });
            
            addLog(`📊 Total recebido: R$ ${totalCash.toLocaleString()} | Redução de renda: R$ ${totalCashflowReduction}/mês`);
            
            closeModal('sellAssetsModal');
            declineCard();
            updateCurrentPlayerInfo();
        }

        // =========== MODAL PARA VENDA DE AÇÕES (COM REGRAS ESPECIAIS) ===========
        function showSellStocksModal(playerId) {
            const player = gameState.players[playerId];
            const marketCard = gameState.marketEvent;
            
            if (player.assets.stocks.length === 0) {
                alert("Você não possui ações para vender.");
                declineCard();
                return;
            }
            
            let html = '<p>Selecione quais ações deseja vender:</p>';
            
            player.assets.stocks.forEach((asset, index) => {
                const totalCost = asset.shares * asset.costPerShare;
                let saleValue = Math.round(totalCost * marketCard.modifier);
                
                if (asset.name.includes("MYT4U")) {
                    const maxSellableShares = Math.floor(asset.shares * 0.5);
                    const maxSaleValue = Math.round((maxSellableShares * asset.costPerShare) * marketCard.modifier);
                    saleValue = maxSaleValue;
                    html += `<div style="color: #e67e22; font-size: 0.8rem; margin-bottom: 5px;"><i class="fas fa-info-circle"></i> MYT4U: só pode vender 50% das ações por evento</div>`;
                } else if (asset.name.includes("ON2U")) {
                    html += `<div style="color: #e67e22; font-size: 0.8rem; margin-bottom: 5px;"><i class="fas fa-info-circle"></i> ON2U: venda somente permitida em mercado de alta</div>`;
                }
                
                const profit = saleValue - totalCost;
                
                html += `
                    <div class="asset-item">
                        <div class="asset-info">
                            <strong>${asset.name}</strong><br>
                            <small>${asset.shares} ações a R$ ${asset.costPerShare}/cada</small><br>
                            <small>Investido: R$ ${totalCost.toLocaleString()}</small><br>
                            <small>Valor de venda: R$ ${saleValue.toLocaleString()} (${profit > 0 ? '+' : ''}R$ ${profit.toLocaleString()})</small><br>
                            ${asset.cashflow > 0 ? `<small>Dividendo: R$ ${asset.cashflow}/mês</small>` : ''}
                            ${asset.specialRules ? `<small style="color: #666;">${asset.specialRules}</small>` : ''}
                        </div>
                        <div class="sell-checkbox">
                            <input type="checkbox" id="stocks${index}" data-index="${index}" data-value="${saleValue}" data-cashflow="${asset.cashflow}" data-name="${asset.name}" data-shares="${asset.shares}">
                            <label for="stocks${index}">Vender</label>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('sellStocksContent').innerHTML = html;
            document.getElementById('sellStocksModal').style.display = 'flex';
        }

        function confirmSellStocks() {
            const player = gameState.players[gameState.currentCard.playerId];
            const checkboxes = document.querySelectorAll('#sellStocksContent input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert("Selecione pelo menos uma ação para vender.");
                return;
            }
            
            const indicesToRemove = [];
            let totalCash = 0;
            let totalCashflowReduction = 0;
            
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                const saleValue = parseInt(checkbox.dataset.value);
                const cashflow = parseInt(checkbox.dataset.cashflow);
                const stockName = checkbox.dataset.name;
                const currentShares = parseInt(checkbox.dataset.shares);
                
                indicesToRemove.push({ index, saleValue, cashflow, stockName, currentShares });
            });
            
            indicesToRemove.sort((a, b) => b.index - a.index);
            
            indicesToRemove.forEach(item => {
                const asset = player.assets.stocks[item.index];
                
                if (item.stockName.includes("MYT4U")) {
                    const sharesToRemove = Math.floor(item.currentShares * 0.5);
                    if (sharesToRemove > 0) {
                        asset.shares -= sharesToRemove;
                        if (asset.shares <= 0) {
                            player.assets.stocks.splice(item.index, 1);
                        }
                    }
                } else {
                    player.assets.stocks.splice(item.index, 1);
                }
                
                player.cash += item.saleValue;
                player.passiveIncome -= item.cashflow;
                totalCash += item.saleValue;
                totalCashflowReduction += item.cashflow;
                
                addLog(`💰 ${player.name} vendeu ${item.stockName} por R$ ${item.saleValue.toLocaleString()}`);
            });
            
            addLog(`📊 Total recebido: R$ ${totalCash.toLocaleString()} | Redução de renda: R$ ${totalCashflowReduction}/mês`);
            
            closeModal('sellStocksModal');
            declineCard();
            updateCurrentPlayerInfo();
        }

        // =========== EVENTOS DO TABULEIRO ===========
        function payday(playerId) {
            const player = gameState.players[playerId];
            
            // Verificar se está demitido
            if (player.isDownsized) {
                player.downsizedRounds++;
                
                if (player.downsizedRounds >= 2) {
                    player.isDownsized = false;
                    player.downsizedRounds = 0;
                    addLog(`🎉 ${player.name} voltou ao trabalho! Agora recebe salário normalmente.`);
                } else {
                    const childExpenses = player.children * player.perChildCost;
                    const totalExpenses = player.expenses + childExpenses;
                    const totalIncome = player.passiveIncome;
                    
                    let loanPayments = 0;
                    player.loans.forEach(loan => {
                        loanPayments += loan.monthlyPayment;
                    });
                    
                    const netIncome = totalIncome - totalExpenses - loanPayments;
                    player.cash += netIncome;
                    
                    addLog(`⏸️ ${player.name} está demitido! Recebeu apenas: Renda Passiva R$ ${player.passiveIncome} - Despesas R$ ${totalExpenses} - Empréstimos R$ ${loanPayments} = R$ ${netIncome.toLocaleString()}`);
                    updateCurrentPlayerInfo();
                    return;
                }
            }
            
            const childExpenses = player.children * player.perChildCost;
            const totalExpenses = player.expenses + childExpenses;
            const totalIncome = player.salary + player.passiveIncome;
            
            let loanPayments = 0;
            player.loans.forEach(loan => {
                loanPayments += loan.monthlyPayment;
            });
            
            const netIncome = totalIncome - totalExpenses - loanPayments;
            player.cash += netIncome;
            
            addLog(`💰 ${player.name} recebeu: Salário R$ ${player.salary} + Renda Passiva R$ ${player.passiveIncome} - Despesas R$ ${totalExpenses} - Empréstimos R$ ${loanPayments} = R$ ${netIncome.toLocaleString()}`);
            
            updateCurrentPlayerInfo();
        }

        function haveBaby(playerId) {
            const player = gameState.players[playerId];
            
            if (player.children >= player.maxChildren) {
                addLog(`👶 ${player.name} já tem o máximo de 3 filhos!`);
                return;
            }
            
            player.children++;
            addLog(`👶 ${player.name} teve um bebê! Total: ${player.children} filho(s) (+R$ ${player.perChildCost}/mês cada)`);
            updateCurrentPlayerInfo();
        }

        function charity(playerId) {
            const player = gameState.players[playerId];
            const amount = Math.floor(player.salary * 0.1);
            
            if (player.cash >= amount) {
                player.cash -= amount;
                addLog(`❤️ ${player.name} doou R$ ${amount.toLocaleString()} para caridade`);
                
                gameState.dice3Enabled = true;
                gameState.charityPlayer = playerId;
                gameState.charityRoundsLeft = 3;
                
                document.getElementById('dice2').style.display = 'flex';
                document.getElementById('dice2').textContent = '?';
                
                addLog(`🎲 Próximas 3 rodadas, ${player.name} pode rolar 2 dados!`);
            } else {
                alert(`Dinheiro insuficiente para caridade! Necessário: R$ ${amount.toLocaleString()}`);
            }
            
            updateCurrentPlayerInfo();
        }

        function downsized(playerId) {
            const player = gameState.players[playerId];
            const childExpenses = player.children * player.perChildCost;
            const totalExpenses = player.expenses + childExpenses;
            
            player.assets.businesses.forEach(business => {
                if (business.name.includes("Fast Food")) {
                    const reducedCashflow = Math.floor(business.cashflow * 0.5);
                    addLog(`🍔 ${player.name} negócio Fast Food afetado! Fluxo reduzido de R$ ${business.cashflow} para R$ ${reducedCashflow}/mês por 2 rodadas`);
                    business.cashflow = reducedCashflow;
                }
            });
            
            if (player.cash >= totalExpenses) {
                player.cash -= totalExpenses;
                addLog(`⚠️ ${player.name} foi demitido! Pagou R$ ${totalExpenses.toLocaleString()} em despesas.`);
            } else {
                const deficit = totalExpenses - player.cash;
                
                player.cash = 0;
                
                const loanAmount = deficit;
                const monthlyPayment = loanAmount * 0.1;
                
                player.loans.push({
                    amount: loanAmount,
                    interestRate: 0.1,
                    monthlyPayment: monthlyPayment,
                    takenAt: Date.now(),
                    reason: "Demissão - Déficit automático"
                });
                
                player.expenses += monthlyPayment;
                
                addLog(`⚠️ ${player.name} foi demitido! Saldo insuficiente: R$ ${(totalExpenses - deficit).toLocaleString()} disponíveis, precisa de R$ ${totalExpenses.toLocaleString()}`);
                addLog(`🏦 Empréstimo automático gerado: R$ ${loanAmount.toLocaleString()} (pagamento: R$ ${monthlyPayment.toLocaleString()}/mês)`);
                addLog(`💰 Saldo zerado. Dívida total: R$ ${player.loans.reduce((sum, loan) => sum + loan.amount, 0).toLocaleString()}`);
            }
            
            player.isDownsized = true;
            player.downsizedRounds = 0;
            
            updateCurrentPlayerInfo();
        }

        // =========== SAIR DA CORRIDA DOS RATOS ===========
        function checkExitRatRace(playerId) {
            const player = gameState.players[playerId];
            const childExpenses = player.children * player.perChildCost;
            const totalExpenses = player.expenses + childExpenses;
            
            if (player.passiveIncome > totalExpenses && player.inRatRace) {
                player.inRatRace = false;
                addLog(`🚀🎉 ${player.name} SAIU DA CORRIDA DOS RATOS!`);
                addLog(`💰 Renda passiva (R$ ${player.passiveIncome}/mês) > Despesas (R$ ${totalExpenses}/mês)`);
                addLog(`🎯 Agora está na VIA RÁPIDA (FAST TRACK)!`);
                addLog(`💭 Sonho de ${player.name}: ${player.assignedDream}`);
                
                updateBoard();
                updateGameStats();
            }
        }

        // =========== FAST TRACK ===========
        function showFastTrackOpportunity() {
            const player = gameState.players[gameState.currentPlayer];
            const card = fastTrackCards[Math.floor(Math.random() * fastTrackCards.length)];
            gameState.currentCard = { ...card, playerId: player.id, cardType: 'fast' };
            
            const display = document.getElementById('cardDisplay');
            const title = document.getElementById('cardTitle');
            const typeTag = document.getElementById('cardTypeTag');
            const description = document.getElementById('cardDescription');
            const details = document.getElementById('cardDetails');
            const actions = document.getElementById('cardActions');
            
            title.textContent = card.nome;
            typeTag.textContent = 'FAST TRACK';
            typeTag.style.backgroundColor = '#9b59b6';
            description.textContent = card.descricao;
            
            if (card.tipo === 'gasto') {
                details.innerHTML = `
                    <div class="card-detail">
                        <div class="detail-label">Tipo</div>
                        <div class="detail-value">Experiência / Gasto</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Custo</div>
                        <div class="detail-value" style="color: #e74c3c;">R$ ${card.custo.toLocaleString()}</div>
                    </div>
                `;
                
                actions.innerHTML = `
                    <button class="button ${player.cash >= card.custo ? 'button-danger' : ''}" onclick="fastTrackSpend(${player.id})" ${player.cash < card.custo ? 'disabled' : ''}>
                        <i class="fas fa-check"></i> ${player.cash >= card.custo ? 'GASTAR' : 'DINHEIRO INSUFICIENTE'}
                    </button>
                    <button class="button" onclick="declineCard()">
                        <i class="fas fa-times"></i> RECUSAR
                    </button>
                `;
                
            } else if (card.tipo === 'investimento') {
                details.innerHTML = `
                    <div class="card-detail">
                        <div class="detail-label">Tipo</div>
                        <div class="detail-value">Investimento</div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-label">Entrada</div>
                        <div class="detail-value">R$ ${card.entrada.toLocaleString()}</div>
                    </div>
                    ${card.ccr ? `
                    <div class="card-detail">
                        <div class="detail-label">CCR</div>
                        <div class="detail-value">${card.ccr}%</div>
                    </div>
                    ` : ''}
                    ${card.fluxo ? `
                    <div class="card-detail">
                        <div class="detail-label">Fluxo Mensal</div>
                        <div class="detail-value" style="color: #2ecc71;">+R$ ${card.fluxo.toLocaleString()}</div>
                    </div>
                    ` : ''}
                `;
                
                actions.innerHTML = `
                    <button class="button ${player.cash >= card.entrada ? 'button-success' : ''}" onclick="fastTrackInvest(${player.id})" ${player.cash < card.entrada ? 'disabled' : ''}>
                        <i class="fas fa-check"></i> ${player.cash >= card.entrada ? 'INVESTIR' : 'DINHEIRO INSUFICIENTE'}
                    </button>
                    <button class="button" onclick="declineCard()">
                        <i class="fas fa-times"></i> RECUSAR
                    </button>
                `;
                
            } else if (card.tipo === 'penalidade') {
                if (card.id === 'auditoria') {
                    const amount = Math.floor(player.cash * 0.5);
                    details.innerHTML = `
                        <div class="card-detail">
                            <div class="detail-label">Tipo</div>
                            <div class="detail-value">Penalidade</div>
                        </div>
                        <div class="card-detail">
                            <div class="detail-label">Descrição</div>
                            <div class="detail-value">Auditoria Fiscal</div>
                        </div>
                        <div class="card-detail">
                            <div class="detail-label">Valor</div>
                            <div class="detail-value" style="color: #e74c3c;">50% do seu dinheiro: R$ ${amount.toLocaleString()}</div>
                        </div>
                        <div class="card-detail">
                            <div class="detail-label">Regra</div>
                            <div class="detail-value">Não pode ser evitada por proteção</div>
                        </div>
                    `;
                    
                    actions.innerHTML = `
                        <button class="button button-danger" onclick="fastTrackPenalty(${player.id})">
                            <i class="fas fa-exclamation-triangle"></i> PAGAR
                        </button>
                    `;
                } else if (card.id === 'processo') {
                    details.innerHTML = `
                        <div class="card-detail">
                            <div class="detail-label">Tipo</div>
                            <div class="detail-value">Penalidade</div>
                        </div>
                        <div class="card-detail">
                            <div class="detail-label">Descrição</div>
                            <div class="detail-value">Processo Judicial</div>
                        </div>
                        <div class="card-detail">
                            <div class="detail-label">Custo</div>
                            <div class="detail-value" style="color: #e74c3c;">R$ ${card.custo.toLocaleString()}</div>
                        </div>
                    `;
                    
                    actions.innerHTML = `
                        <button class="button ${player.cash >= card.custo ? 'button-danger' : ''}" onclick="fastTrackPenalty(${player.id})" ${player.cash < card.custo ? 'disabled' : ''}>
                            <i class="fas fa-exclamation-triangle"></i> ${player.cash >= card.custo ? 'PAGAR' : 'DINHEIRO INSUFICIENTE'}
                        </button>
                    `;
                }
            }
            
            display.style.display = 'block';
        }

        function fastTrackSpend(playerId) {
            const card = gameState.currentCard;
            const player = gameState.players[playerId];
            
            if (player.cash < card.custo) {
                alert("Dinheiro insuficiente!");
                return;
            }
            
            player.cash -= card.custo;
            
            if (card.nome === player.assignedDream || card.custo >= 100000) {
                player.dreams.push(card.nome);
                addLog(`🏆 ${player.name} realizou o sonho: ${card.nome} por R$ ${card.custo.toLocaleString()}`);
                
                if (card.nome === player.assignedDream) {
                    declareWinner(playerId);
                }
            } else {
                addLog(`💸 ${player.name} gastou R$ ${card.custo.toLocaleString()} em ${card.nome}`);
            }
            
            document.getElementById('cardDisplay').style.display = 'none';
            updateCurrentPlayerInfo();
            updateFastTrackSection();
        }

        function fastTrackInvest(playerId) {
            const card = gameState.currentCard;
            const player = gameState.players[playerId];
            
            if (player.cash < card.entrada) {
                alert("Dinheiro insuficiente!");
                return;
            }
            
            player.cash -= card.entrada;
            
            if (card.fluxo) {
                player.passiveIncome += card.fluxo;
                addLog(`✅ ${player.name} investiu R$ ${card.entrada.toLocaleString()} em ${card.nome} (renda: +R$ ${card.fluxo}/mês)`);
            } else if (card.ccr) {
                const monthlyReturn = (card.entrada * (card.ccr / 100)) / 12;
                player.passiveIncome += monthlyReturn;
                addLog(`✅ ${player.name} investiu R$ ${card.entrada.toLocaleString()} em ${card.nome} (CCR: ${card.ccr}%, renda: +R$ ${monthlyReturn.toLocaleString()}/mês)`);
            }
            
            document.getElementById('cardDisplay').style.display = 'none';
            updateCurrentPlayerInfo();
            updateFastTrackSection();
        }

        function fastTrackPenalty(playerId) {
            const card = gameState.currentCard;
            const player = gameState.players[playerId];
            
            if (card.id === 'auditoria') {
                const amount = Math.floor(player.cash * 0.5);
                player.cash -= amount;
                addLog(`⚠️ ${player.name} pagou R$ ${amount.toLocaleString()} em auditoria fiscal`);
            } else if (card.id === 'processo') {
                if (player.cash < card.custo) {
                    alert("Dinheiro insuficiente para pagar o processo!");
                    return;
                }
                player.cash -= card.custo;
                addLog(`⚠️ ${player.name} pagou R$ ${card.custo.toLocaleString()} em processo judicial`);
            }
            
            document.getElementById('cardDisplay').style.display = 'none';
            updateCurrentPlayerInfo();
        }

        // =========== VITÓRIA ===========
        function declareWinner(playerId) {
            const player = gameState.players[playerId];
            gameState.gameActive = false;
            
            const winnerDiv = document.getElementById('winnerMessage');
            winnerDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); 
                           color: white; padding: 20px; border-radius: 10px; 
                           text-align: center; margin-top: 15px; font-weight: bold; font-size: 1.2rem;">
                    🏆🎉 ${player.name} VENCEU O JOGO! 🎉🏆<br>
                    <small>Realizou o sonho: ${player.assignedDream}</small>
                </div>
            `;
            
            addLog(`🏆🎉 ${player.name} VENCEU O JOGO NO FAST TRACK! PARABÉNS!`);
            addLog(`🎯 Sonho realizado: ${player.assignedDream}`);
            
            document.getElementById('rollDiceBtn').disabled = true;
            document.getElementById('endTurnBtn').disabled = true;
        }

        // =========== TURNO ===========
        function endTurn() {
            if (!gameState.dice3Enabled) {
                document.getElementById('dice2').style.display = 'none';
            }
            
            gameState.currentPlayer = gameState.currentPlayer % gameState.totalPlayers + 1;
            
            if (gameState.currentPlayer === 1) {
                gameState.currentRound++;
                addLog(`📅 RODADA ${gameState.currentRound} INICIADA`);
                updateGameStats();
            }
            
            document.getElementById('endTurnBtn').disabled = true;
            document.getElementById('rollDiceBtn').disabled = false;
            
            document.getElementById('cardDisplay').style.display = 'none';
            
            updateCurrentPlayerInfo();
            updateProtectionButton();
            
            const playerName = gameState.players[gameState.currentPlayer].name;
            addLog(`🔄 Vez de: ${playerName}`);
            
            if (!gameState.players[gameState.currentPlayer].inRatRace) {
                setTimeout(() => {
                    showFastTrackOpportunity();
                }, 500);
            }
        }

        // =========== ATIVOS ===========
        function showAssets() {
            const player = gameState.players[gameState.currentPlayer];
            let html = `<h3 style="color: var(--secondary); margin-bottom: 15px;">${player.name} - ${player.profession}</h3>`;
            
            const childExpenses = player.children * player.perChildCost;
            const totalExpenses = player.expenses + childExpenses;
            
            let totalLoans = 0;
            let totalLoanPayments = 0;
            player.loans.forEach(loan => {
                totalLoans += loan.amount;
                totalLoanPayments += loan.monthlyPayment;
            });
            
            html += `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div>
                            <div style="color: #666; font-size: 0.9rem;">Salário</div>
                            <div style="font-weight: bold;">R$ ${player.salary.toLocaleString()}/mês</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9rem;">Despesas Fixas</div>
                            <div style="font-weight: bold; color: #e74c3c;">R$ ${player.expenses.toLocaleString()}/mês</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9rem;">Renda Passiva</div>
                            <div style="font-weight: bold; color: #2ecc71;">R$ ${player.passiveIncome.toLocaleString()}/mês</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9rem;">Filhos</div>
                            <div style="font-weight: bold;">${player.children} (R$ ${childExpenses}/mês)</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9rem;">Despesas Totais</div>
                            <div style="font-weight: bold; color: #e74c3c;">R$ ${totalExpenses.toLocaleString()}/mês</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 0.9rem;">Fluxo de Caixa</div>
                            <div style="font-weight: bold; color: ${player.salary + player.passiveIncome - totalExpenses - totalLoanPayments >= 0 ? '#2ecc71' : '#e74c3c'}">
                                R$ ${(player.salary + player.passiveIncome - totalExpenses - totalLoanPayments).toLocaleString()}/mês
                            </div>
                        </div>
                        ${totalLoans > 0 ? `
                        <div style="grid-column: 1 / -1; background: #e74c3c10; padding: 10px; border-radius: 5px;">
                            <div style="color: #666; font-size: 0.9rem;">Empréstimos</div>
                            <div style="font-weight: bold; color: #e74c3c;">
                                Total: R$ ${totalLoans.toLocaleString()} | Pagamentos: R$ ${totalLoanPayments.toLocaleString()}/mês
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            if (player.assets.stocks.length > 0) {
                html += `<h4 style="color: #3498db; margin-top: 15px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">AÇÕES E FUNDOS</h4>`;
                player.assets.stocks.forEach((stock, index) => {
                    const totalCost = stock.shares * stock.costPerShare;
                    html += `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                            <div><strong>${stock.name}</strong></div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>${stock.shares} ações a R$ ${stock.costPerShare}</span>
                                <span>Investido: R$ ${totalCost.toLocaleString()}</span>
                                ${stock.cashflow > 0 ? `<span style="color: #2ecc71;">Renda: +R$ ${stock.cashflow}/mês</span>` : ''}
                            </div>
                            ${stock.specialRules ? `<div style="color: #e67e22; font-size: 0.8rem; margin-top: 3px;"><i class="fas fa-exclamation-triangle"></i> ${stock.specialRules}</div>` : ''}
                            ${stock.roi ? `<div style="color: #666; font-size: 0.8rem; margin-top: 3px;">${stock.roi}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            if (player.assets.realEstate.length > 0) {
                html += `<h4 style="color: #e67e22; margin-top: 15px; border-bottom: 2px solid #e67e22; padding-bottom: 5px;">IMÓVEIS</h4>`;
                player.assets.realEstate.forEach((property, index) => {
                    html += `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                            <div><strong>${property.name}</strong></div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>Valor: R$ ${property.cost.toLocaleString()}</span>
                                <span>Entrada: R$ ${property.downPayment.toLocaleString()}</span>
                                <span style="color: #2ecc71;">Renda: +R$ ${property.cashflow}/mês</span>
                            </div>
                            ${property.mortgage > 0 ? `<div style="color: #666; font-size: 0.8rem;">Financiamento: R$ ${property.mortgage.toLocaleString()}</div>` : ''}
                            ${property.roi ? `<div style="color: #666; font-size: 0.8rem; margin-top: 3px;">${property.roi}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            if (player.assets.businesses.length > 0) {
                html += `<h4 style="color: #9b59b6; margin-top: 15px; border-bottom: 2px solid #9b59b6; padding-bottom: 5px;">NEGÓCIOS</h4>`;
                player.assets.businesses.forEach((business, index) => {
                    html += `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                            <div><strong>${business.name}</strong></div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>Valor: R$ ${business.cost.toLocaleString()}</span>
                                <span>Entrada: R$ ${business.downPayment.toLocaleString()}</span>
                                <span style="color: #2ecc71;">Renda: +R$ ${business.cashflow}/mês</span>
                            </div>
                            ${business.roi ? `<div style="color: #666; font-size: 0.8rem; margin-top: 3px;">${business.roi}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            if (player.assets.bonds.length > 0) {
                html += `<h4 style="color: #2ecc71; margin-top: 15px; border-bottom: 2px solid #2ecc71; padding-bottom: 5px;">TÍTULOS E FUNDOS</h4>`;
                player.assets.bonds.forEach((bond, index) => {
                    html += `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                            <div><strong>${bond.name}</strong></div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>Investido: R$ ${bond.cost.toLocaleString()}</span>
                                <span style="color: #2ecc71;">Renda: +R$ ${bond.cashflow}/mês</span>
                            </div>
                            ${bond.roi ? `<div style="color: #666; font-size: 0.8rem; margin-top: 3px;">${bond.roi}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            if (player.assets.protection) {
                html += `<h4 style="color: #27ae60; margin-top: 15px; border-bottom: 2px solid #27ae60; padding-bottom: 5px;">PROTEÇÃO FINANCEIRA</h4>`;
                html += `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <div><strong>${player.assets.protection.name}</strong></div>
                        <div style="color: #666; margin-top: 5px;">${player.assets.protection.description}</div>
                        <div style="color: #27ae60; margin-top: 5px;"><i class="fas fa-shield-alt"></i> Pronta para uso</div>
                    </div>
                `;
            }
            
            if (player.assets.stocks.length === 0 && player.assets.realEstate.length === 0 && 
                player.assets.businesses.length === 0 && player.assets.bonds.length === 0 && !player.assets.protection) {
                html += '<p>Nenhum ativo adquirido.</p>';
            }
            
            html += `<h4 style="color: #f39c12; margin-top: 20px; border-bottom: 2px solid #f39c12; padding-bottom: 5px;">SONHO</h4>`;
            html += `<p><strong>${player.assignedDream}</strong></p>`;
            
            if (player.dreams.length > 0) {
                html += `<h4 style="color: #f39c12; margin-top: 20px; border-bottom: 2px solid #f39c12; padding-bottom: 5px;">SONHOS REALIZADOS</h4>`;
                player.dreams.forEach(dream => {
                    html += `<p>⭐ ${dream}</p>`;
                });
            }
            
            document.getElementById('assetsContent').innerHTML = html;
            document.getElementById('assetsTitle').textContent = `${player.name} - Situação Financeira`;
            document.getElementById('assetsModal').style.display = 'flex';
        }

        // =========== FUNÇÕES AUXILIARES ===========
        function addLog(message) {
            const log = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            log.prepend(entry);
            
            if (log.children.length > 30) {
                log.removeChild(log.lastChild);
            }
        }

        function clearLog() {
            document.getElementById('gameLog').innerHTML = '<div class="log-entry">Histórico limpo</div>';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function declineCard() {
            const player = gameState.players[gameState.currentCard.playerId];
            addLog(`❌ ${player.name} recusou a oferta`);
            document.getElementById('cardDisplay').style.display = 'none';
        }

        // =========== INICIALIZAR ===========
        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>